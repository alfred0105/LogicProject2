<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <!-- Î™®Î∞îÏùº Í∏∞Í∏∞ ÏûêÎèô Î¶¨ÎîîÎ†âÏÖò (Í∞ÄÏû• Î®ºÏ†Ä Ïã§Ìñâ) -->
    <script>
        (function () {
            var isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            if (isMobile && !window.location.pathname.includes('mobile_simulator')) {
                window.location.replace('mobile_simulator.html' + window.location.search);
            }
        })();
    </script>

    <title>Logic Sim</title>
    <meta name="description" content="ÍµêÏú°Ïö© ÎîîÏßÄÌÑ∏ ÎÖºÎ¶¨ ÌöåÎ°ú ÏãúÎÆ¨Î†àÏù¥ÌÑ∞">
    <!-- [Î≥¥Ïïà] Î™®Îì† Ìò∏Ïä§ÌåÖ(Netlify, GitHub Pages Îì±)ÏóêÏÑú eval() ÌóàÏö© -->
    <meta http-equiv="Content-Security-Policy"
        content="default-src 'self' 'unsafe-inline' 'unsafe-eval' https: data: blob:;">

    <link rel="stylesheet" href="css/simulator.css?v=2.7">
    <link rel="stylesheet" href="css/tabs.css?v=2.7">

    <link rel="stylesheet" href="css/validation.css">
    <link rel="stylesheet" href="css/collaboration.css">
    <script src="js/modules/Security.js"></script>
    <link rel="icon" href="favicon.svg" type="image/svg+xml">
    <script>
        // Ï¥àÍ∏∞ Î°úÎî© ÏóêÎü¨(ReferenceError: sim is not defined) Î∞©ÏßÄÏö© ÎçîÎØ∏ Í∞ùÏ≤¥
        window.sim = window.sim || {
            showTooltip: function () { },
            hideTooltip: function () { },
            positionTooltip: function () { },
            toggleSection: function () { },
            addModule: function () { },
            saveProject: function () { },
            updateProjectName: function () { },
            exportProject: function () { },
            cloud: {
                saveProjectToCloud: function () { },
                triggerAutoSave: function () { }
            }
        };
    </script>
</head>

<body>
    <!-- Loading Screen -->
    <div id="loading-screen" class="loading-screen">
        <div class="loading-content">
            <div class="loading-logo">
                <svg viewBox="0 0 24 24" width="80" height="80">
                    <path
                        d="M6 6 L10 2 L12 6 H20 A2 2 0 0 1 22 8 V17 A2 2 0 0 1 20 19 H14 L10 23 L9 19 H4 A2 2 0 0 1 2 17 V8 A2 2 0 0 1 4 6 Z"
                        fill="none" stroke="#3b82f6" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                    </path>
                    <circle cx="9" cy="12.5" r="1.5" fill="#3b82f6" stroke="none"></circle>
                    <circle cx="15" cy="12.5" r="1.5" fill="#3b82f6" stroke="none"></circle>
                </svg>
            </div>
            <h2 class="loading-title">LoCAD</h2>
            <p class="loading-subtitle">ÏãúÎÆ¨Î†àÏù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî Ï§ë...</p>
            <div class="loading-bar">
                <div class="loading-bar-fill"></div>
            </div>
        </div>
    </div>

    <style>
        .loading-screen {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }

        .loading-screen.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        .loading-content {
            text-align: center;
        }

        .loading-logo {
            margin-bottom: 24px;
        }

        .loading-circle {
            animation: loading-spin 1.5s linear infinite;
            transform-origin: center;
        }

        @keyframes loading-spin {
            to {
                stroke-dashoffset: -176;
            }
        }

        .loading-title {
            font-size: 32px;
            font-weight: 700;
            color: #f8fafc;
            margin: 0 0 8px 0;
            letter-spacing: -0.02em;
        }

        .loading-subtitle {
            font-size: 14px;
            color: #64748b;
            margin: 0 0 24px 0;
        }

        .loading-bar {
            width: 200px;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
            margin: 0 auto;
        }

        .loading-bar-fill {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            border-radius: 2px;
            animation: loading-progress 2s ease-out forwards;
        }

        @keyframes loading-progress {
            0% {
                width: 0%;
            }

            50% {
                width: 70%;
            }

            100% {
                width: 100%;
            }
        }
    </style>

    <!-- SVG Icon Definitions -->
    <svg style="display: none;">
        <defs>
            <!-- Logo (Lightning Speech Bubble) -->
            <symbol id="icon-logo" viewBox="0 0 24 24">
                <path
                    d="M6 6 L10 2 L12 6 H20 A2 2 0 0 1 22 8 V17 A2 2 0 0 1 20 19 H14 L10 23 L9 19 H4 A2 2 0 0 1 2 17 V8 A2 2 0 0 1 4 6 Z"
                    fill="none" stroke="#3b82f6" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                </path>
                <circle cx="9" cy="12.5" r="1.5" fill="#3b82f6" stroke="none"></circle>
                <circle cx="15" cy="12.5" r="1.5" fill="#3b82f6" stroke="none"></circle>
            </symbol>

            <symbol id="icon-lightning" viewBox="0 0 24 24">
                <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" fill="currentColor" stroke="none" />
            </symbol>

            <symbol id="icon-settings" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="3"></circle>
                <path
                    d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
                </path>
            </symbol>

            <!-- UI Icons -->
            <symbol id="icon-home" viewBox="0 0 24 24">
                <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z" />
            </symbol>
            <symbol id="icon-chevron-left" viewBox="0 0 24 24">
                <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z" />
            </symbol>
            <symbol id="icon-chevron-right" viewBox="0 0 24 24">
                <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z" />
            </symbol>
            <symbol id="icon-chevron-down" viewBox="0 0 24 24">
                <path d="M16.59 8.59L12 13.17 7.41 8.59 6 10l6 6 6-6z" />
            </symbol>

            <!-- File Icons -->
            <symbol id="icon-file" viewBox="0 0 24 24">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                <polyline points="14 2 14 8 20 8" />
            </symbol>
            <symbol id="icon-save" viewBox="0 0 24 24">
                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" />
                <polyline points="17 21 17 13 7 13 7 21" />
                <polyline points="7 3 7 8 15 8" />
            </symbol>
            <symbol id="icon-export" viewBox="0 0 24 24">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                <polyline points="17 8 12 3 7 8" />
                <line x1="12" y1="3" x2="12" y2="15" />
            </symbol>

            <!-- Edit Icons (Undo/Redo Updated) -->
            <symbol id="icon-undo" viewBox="0 0 24 24">
                <path
                    d="M12.5 8c-2.65 0-5.05.99-6.9 2.6L2 7v9h9l-3.62-3.62c1.39-1.16 3.16-1.88 5.12-1.88 3.54 0 6.55 2.31 7.6 5.5l2.37-.78C21.08 11.03 17.17 8 12.5 8z" />
            </symbol>
            <symbol id="icon-redo" viewBox="0 0 24 24">
                <path
                    d="M18.4 10.6C16.55 9 14.15 8 11.5 8c-4.67 0-8.58 3.03-9.96 7.22L3.9 16c1.05-3.19 4.05-5.5 7.6-5.5 1.95 0 3.73.72 5.12 1.88L13 16h9V7l-3.6 3.6z" />
            </symbol>
            <symbol id="icon-copy" viewBox="0 0 24 24">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2" />
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" />
            </symbol>
            <symbol id="icon-paste" viewBox="0 0 24 24">
                <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2" />
                <rect x="8" y="2" width="8" height="4" rx="1" ry="1" />
            </symbol>
            <symbol id="icon-duplicate" viewBox="0 0 24 24">
                <rect x="3" y="3" width="8" height="8" rx="1" />
                <rect x="13" y="13" width="8" height="8" rx="1" />
                <path d="M11 8h2v3h3v2h-3v3h-2v-3H8v-2h3V8z" />
            </symbol>
            <symbol id="icon-trash" viewBox="0 0 24 24">
                <polyline points="3 6 5 6 21 6" />
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
            </symbol>

            <!-- Tool Icons -->
            <symbol id="icon-select" viewBox="0 0 24 24">
                <path d="M3 3l7.07 16.97 2.51-7.39 7.39-2.51L3 3z" />
            </symbol>
            <symbol id="icon-pan" viewBox="0 0 24 24">
                <path
                    d="M18 11V6a2 2 0 0 0-2-2 2 2 0 0 0-2 2v1a2 2 0 0 0-2-2 2 2 0 0 0-2 2v5a6 6 0 0 0 6 6h2a6 6 0 0 0 6-6V9a2 2 0 0 0-2-2 2 2 0 0 0-2 2" />
            </symbol>
            <symbol id="icon-wire" viewBox="0 0 24 24">
                <rect x="5" y="5" width="14" height="14" rx="2" fill="none" stroke="currentColor" stroke-width="2" />
                <line x1="9" y1="19" x2="9" y2="23" stroke="currentColor" stroke-width="2" />
                <line x1="15" y1="19" x2="15" y2="23" stroke="currentColor" stroke-width="2" />
                <line x1="9" y1="1" x2="9" y2="5" stroke="currentColor" stroke-width="2" />
                <line x1="15" y1="1" x2="15" y2="5" stroke="currentColor" stroke-width="2" />
                <line x1="1" y1="9" x2="5" y2="9" stroke="currentColor" stroke-width="2" />
                <line x1="1" y1="15" x2="5" y2="15" stroke="currentColor" stroke-width="2" />
                <line x1="19" y1="9" x2="23" y2="9" stroke="currentColor" stroke-width="2" />
                <line x1="19" y1="15" x2="23" y2="15" stroke="currentColor" stroke-width="2" />
            </symbol>
            <symbol id="icon-grid" viewBox="0 0 24 24">
                <path d="M3 3h18v18H3z" stroke="currentColor" fill="none" stroke-width="2" />
                <path d="M8 3v18M13 3v18M18 3v18M3 8h18M3 13h18M3 18h18" stroke="currentColor" stroke-width="1"
                    opacity="0.6" />
            </symbol>

            <!-- Playback Icons -->
            <symbol id="icon-play" viewBox="0 0 24 24">
                <polygon points="5 3 19 12 5 21 5 3" fill="currentColor" />
            </symbol>
            <symbol id="icon-pause" viewBox="0 0 24 24">
                <rect x="6" y="4" width="4" height="16" fill="currentColor" />
                <rect x="14" y="4" width="4" height="16" fill="currentColor" />
            </symbol>
            <symbol id="icon-step" viewBox="0 0 24 24">
                <polygon points="5 4 15 12 5 20 5 4" />
                <line x1="19" y1="5" x2="19" y2="19" />
            </symbol>
            <symbol id="icon-reset" viewBox="0 0 24 24">
                <polyline points="1 4 1 10 7 10" />
                <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10" />
            </symbol>

            <!-- Zoom Icons -->
            <symbol id="icon-zoom-in" viewBox="0 0 24 24">
                <circle cx="11" cy="11" r="8" />
                <line x1="21" y1="21" x2="16.65" y2="16.65" />
                <line x1="11" y1="8" x2="11" y2="14" />
                <line x1="8" y1="11" x2="14" y2="11" />
            </symbol>
            <symbol id="icon-zoom-out" viewBox="0 0 24 24">
                <circle cx="11" cy="11" r="8" />
                <line x1="21" y1="21" x2="16.65" y2="16.65" />
                <line x1="8" y1="11" x2="14" y2="11" />
            </symbol>
            <symbol id="icon-zoom-fit" viewBox="0 0 24 24">
                <path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7" />
            </symbol>

            <!-- Component Icons -->
            <symbol id="icon-switch" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10" />
                <path d="M12 8v4l3 3" />
            </symbol>
            <symbol id="icon-led" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="8" />
                <path d="M12 2v2M12 20v2M2 12h2M20 12h2" />
            </symbol>
            <symbol id="icon-clock" viewBox="0 0 24 24">
                <rect x="3" y="3" width="18" height="18" rx="2" />
                <polyline points="8 12 11 12 11 8" />
                <polyline points="13 12 16 16" />
            </symbol>

            <!-- Gate Icons (ANSI Standard Symbols) -->
            <!-- AND Gate: D shape -->
            <symbol id="icon-gate-and" viewBox="0 0 60 40">
                <path d="M10 5 L30 5 A 15 15 0 0 1 30 35 L10 35 Z" fill="none" stroke="currentColor" stroke-width="3" />
                <line x1="10" y1="5" x2="10" y2="35" stroke="currentColor" stroke-width="3" />
            </symbol>

            <!-- OR Gate: Curved shape -->
            <symbol id="icon-gate-or" viewBox="0 0 60 40">
                <path d="M10 5 C 10 5, 20 5, 30 15 C 40 25, 30 35, 10 35 C 15 25, 15 15, 10 5 Z" fill="none"
                    stroke="currentColor" stroke-width="3" />
                <!-- Output line is handled by pin or extended path -->
            </symbol>

            <!-- NOT Gate: Triangle + Bubble -->
            <symbol id="icon-gate-not" viewBox="0 0 60 40">
                <path d="M15 5 L40 20 L15 35 Z" fill="none" stroke="currentColor" stroke-width="3" />
                <circle cx="44" cy="20" r="3" fill="none" stroke="currentColor" stroke-width="3" />
            </symbol>

            <!-- NAND Gate: AND + Bubble -->
            <symbol id="icon-gate-nand" viewBox="0 0 60 40">
                <path d="M10 5 L30 5 A 15 15 0 0 1 30 35 L10 35 Z" fill="none" stroke="currentColor" stroke-width="3" />
                <line x1="10" y1="5" x2="10" y2="35" stroke="currentColor" stroke-width="3" />
                <circle cx="48" cy="20" r="3" fill="none" stroke="currentColor" stroke-width="3" />
            </symbol>

            <!-- NOR Gate: OR + Bubble -->
            <symbol id="icon-gate-nor" viewBox="0 0 60 40">
                <path d="M10 5 C 10 5, 20 5, 30 15 C 40 25, 30 35, 10 35 C 15 25, 15 15, 10 5 Z" fill="none"
                    stroke="currentColor" stroke-width="3" />
                <circle cx="44" cy="20" r="3" fill="none" stroke="currentColor" stroke-width="3" />
            </symbol>

            <!-- XOR Gate: Double curve -->
            <symbol id="icon-gate-xor" viewBox="0 0 60 40">
                <path d="M15 5 C 15 5, 25 5, 35 15 C 45 25, 35 35, 15 35 C 20 25, 20 15, 15 5 Z" fill="none"
                    stroke="currentColor" stroke-width="3" />
                <path d="M8 5 C 13 15, 13 25, 8 35" fill="none" stroke="currentColor" stroke-width="3" />
            </symbol>

            <!-- XNOR Gate: XOR + Bubble -->
            <symbol id="icon-gate-xnor" viewBox="0 0 60 40">
                <path d="M15 5 C 15 5, 25 5, 35 15 C 45 25, 35 35, 15 35 C 20 25, 20 15, 15 5 Z" fill="none"
                    stroke="currentColor" stroke-width="3" />
                <path d="M8 5 C 13 15, 13 25, 8 35" fill="none" stroke="currentColor" stroke-width="3" />
                <circle cx="48" cy="20" r="3" fill="none" stroke="currentColor" stroke-width="3" />
            </symbol>

            <!-- Package/Expert Icons -->
            <symbol id="icon-package" viewBox="0 0 24 24">
                <path
                    d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" />
                <polyline points="3.27 6.96 12 12.01 20.73 6.96" />
                <line x1="12" y1="22.08" x2="12" y2="12" />
            </symbol>
            <symbol id="icon-transistor" viewBox="0 0 24 24">
                <line x1="12" y1="2" x2="12" y2="22" />
                <path d="M4 12h8l-4 6M4 12l4-6" />
            </symbol>
            <symbol id="icon-plus" viewBox="0 0 24 24">
                <line x1="12" y1="5" x2="12" y2="19" />
                <line x1="5" y1="12" x2="19" y2="12" />
            </symbol>

            <!-- Misc Icons -->
            <symbol id="icon-chart" viewBox="0 0 24 24">
                <line x1="18" y1="20" x2="18" y2="10" />
                <line x1="12" y1="20" x2="12" y2="4" />
                <line x1="6" y1="20" x2="6" y2="14" />
            </symbol>
            <symbol id="icon-help" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10" />
                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3" />
                <line x1="12" y1="17" x2="12.01" y2="17" />
            </symbol>
            <symbol id="icon-close" viewBox="0 0 24 24">
                <line x1="18" y1="6" x2="6" y2="18" />
                <line x1="6" y1="6" x2="18" y2="18" />
            </symbol>
            <symbol id="icon-download" viewBox="0 0 24 24">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                <polyline points="7 10 12 15 17 10" />
                <line x1="12" y1="15" x2="12" y2="3" />
            </symbol>
        </defs>
    </svg>

    <div class="app-container">
        <!-- ======== Header ======== -->
        <header class="header">
            <div class="brand">
                <button class="icon-btn" style="width: 32px; height: 32px; min-width: auto; padding: 0;" title="ÌôàÏúºÎ°ú"
                    onclick="goHome()">
                    <svg>
                        <use href="#icon-home" />
                    </svg>
                </button>
                <div class="brand-divider"></div>
                <div class="brand-divider"></div>
                <!-- Brand Logo & Title -->
                <div class="brand-logo" onclick="location.href='index.html'"
                    style="cursor:pointer; padding: 4px; display:flex; align-items:center; gap: 12px;">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <!-- Lightning Speech Bubble -->
                        <path
                            d="M6 6 L10 2 L12 6 H20 A2 2 0 0 1 22 8 V17 A2 2 0 0 1 20 19 H14 L10 23 L9 19 H4 A2 2 0 0 1 2 17 V8 A2 2 0 0 1 4 6 Z">
                        </path>
                        <!-- Two Eyes -->
                        <circle cx="9" cy="12.5" r="1.5" fill="currentColor" stroke="none"></circle>
                        <circle cx="15" cy="12.5" r="1.5" fill="currentColor" stroke="none"></circle>
                    </svg>
                    <span
                        style="font-family:'Inter', sans-serif; font-weight:800; font-size:22px; color:white; letter-spacing: -0.5px;">LoCAD</span>
                </div>
            </div>

            <div class="header-controls" style="display:flex; align-items:center; gap: 6px; margin-left: 16px;">
                <input type="text" id="project-name-input" onchange="sim.updateProjectName(this.value)"
                    value="Untitled Project"
                    style="background: transparent; border: none; color: var(--text-primary); font-size: 14px; font-weight: 500; text-align: left; width: auto; min-width: 120px;">
                <span id="save-status"
                    style="font-size:11px; color:var(--text-secondary); opacity: 1; transition: opacity 0.5s; white-space: nowrap;">Ï†ÄÏû•Îê®</span>
            </div>

            <!-- File -->
            <div class="toolbar-group">
                <button class="icon-btn" onclick="sim.newProject()" title="ÏÉà ÌîÑÎ°úÏ†ùÌä∏ (N)">
                    <svg>
                        <use href="#icon-file" />
                    </svg>
                    <span class="btn-text">ÏÉà ÌååÏùº</span>
                </button>
                <button class="icon-btn" onclick="sim.saveProject()" title="ÌååÏùº Ï†ÄÏû• (S)">
                    <svg>
                        <use href="#icon-save" />
                    </svg>
                    <span class="btn-text">ÏàòÎèô Ï†ÄÏû•</span>
                </button>

                <button class="icon-btn" onclick="sim.exportProject()" title="JSON ÎÇ¥Î≥¥ÎÇ¥Í∏∞">
                    <svg>
                        <use href="#icon-export" />
                    </svg>
                    <span class="btn-text">ÎÇ¥Î≥¥ÎÇ¥Í∏∞</span>
                </button>
            </div>

            <div class="toolbar-divider"></div>

            <!-- Edit -->
            <div class="toolbar-group">
                <button class="icon-btn" onclick="sim.undo()" title="Ïã§Ìñâ Ï∑®ÏÜå (Ctrl+Z)">
                    <svg>
                        <use href="#icon-undo" />
                    </svg>
                    <span class="btn-text">Ï∑®ÏÜå</span>
                </button>
                <button class="icon-btn" onclick="sim.redo()" title="Îã§Ïãú Ïã§Ìñâ (Ctrl+Y)">
                    <svg>
                        <use href="#icon-redo" />
                    </svg>
                    <span class="btn-text">Î≥µÍµ¨</span>
                </button>
                <div class="toolbar-divider"></div>
                <button class="icon-btn" onclick="sim.copySelection()" title="Î≥µÏÇ¨ (Ctrl+C)">
                    <svg>
                        <use href="#icon-copy" />
                    </svg>
                    <span class="btn-text">Î≥µÏÇ¨</span>
                </button>
                <button class="icon-btn" onclick="sim.pasteFromClipboard()" title="Î∂ôÏó¨ÎÑ£Í∏∞ (Ctrl+V)">
                    <svg>
                        <use href="#icon-paste" />
                    </svg>
                    <span class="btn-text">Î∂ôÏó¨ÎÑ£Í∏∞</span>
                </button>
                <button class="icon-btn" onclick="sim.deleteSelected()" title="ÏÇ≠Ï†ú (Del)">
                    <svg>
                        <use href="#icon-trash" />
                    </svg>
                    <span class="btn-text">ÏÇ≠Ï†ú</span>
                </button>
            </div>

            <div class="toolbar-divider"></div>

            <!-- Tools -->
            <div class="toolbar-group">
                <!-- Tool Buttons Removed (Integrated functionality)
                <div class="tool-toggle">
                    <button class="icon-btn active" id="btn-select" onclick="sim.setMode('edit')" title="ÏÑ†ÌÉù ÎèÑÍµ¨ (V)">
                        <svg>
                            <use href="#icon-select" />
                        </svg>
                        <span class="tool-label">ÏÑ†ÌÉù</span>
                    </button>
                    <button class="icon-btn" id="btn-pan" onclick="sim.setMode('pan')" title="ÌôîÎ©¥ Ïù¥Îèô (H)">
                        <svg viewBox="0 0 24 24">
                            <path d="M12 2 L12 22 M2 12 L22 12" stroke="currentColor" stroke-width="2" fill="none"
                                stroke-linecap="round" />
                            <path d="M12 2 L8 6 M12 2 L16 6" stroke="currentColor" stroke-width="2" fill="none"
                                stroke-linecap="round" stroke-linejoin="round" />
                            <path d="M12 22 L8 18 M12 22 L16 18" stroke="currentColor" stroke-width="2" fill="none"
                                stroke-linecap="round" stroke-linejoin="round" />
                            <path d="M2 12 L6 8 M2 12 L6 16" stroke="currentColor" stroke-width="2" fill="none"
                                stroke-linecap="round" stroke-linejoin="round" />
                            <path d="M22 12 L18 8 M22 12 L18 16" stroke="currentColor" stroke-width="2" fill="none"
                                stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                        <span class="tool-label">Ïù¥Îèô</span>
                    </button>
                </div>
                -->

                <!-- Grid & Wire Mode -->
                <div class="edit-options">
                    <button class="icon-btn small" id="btn-grid-snap" onclick="sim.toggleGridSnap()"
                        title="Í∑∏Î¶¨Îìú Ïä§ÎÉÖ ON/OFF">
                        <svg>
                            <use href="#icon-grid" />
                        </svg>
                        <span class="btn-text">Í∑∏Î¶¨Îìú</span>
                    </button>
                    <button class="icon-btn small" id="btn-wire-mode" onclick="sim.toggleWireMode()" title="ÏôÄÏù¥Ïñ¥ Ïó∞Í≤∞ Î™®Îìú">
                        <svg>
                            <use href="#icon-wire" />
                        </svg>
                        <span class="btn-text">Ï†ÑÏÑ†</span>
                    </button>
                </div>
            </div>

            <div class="toolbar-divider"></div>

            <!-- Simulation -->
            <div class="toolbar-group">
                <button class="icon-btn" id="btn-run" onclick="sim.toggleSimulation()" title="ÏãúÎÆ¨Î†àÏù¥ÏÖò ÏãúÏûë/Ï†ïÏßÄ">
                    <svg>
                        <use href="#icon-play" />
                    </svg>
                    <span class="btn-text">Ïã§Ìñâ</span>
                </button>
                <button class="icon-btn" onclick="sim.stepSimulation()" title="Ìïú Îã®Í≥Ñ Ïã§Ìñâ">
                    <svg>
                        <use href="#icon-step" />
                    </svg>
                    <span class="btn-text">Ïä§ÌÖù</span>
                </button>
                <button class="icon-btn" onclick="sim.resetSimulation()" title="ÏãúÎÆ¨Î†àÏù¥ÏÖò Ï¥àÍ∏∞Ìôî">
                    <svg>
                        <use href="#icon-reset" />
                    </svg>
                    <span class="btn-text">Î¶¨ÏÖã</span>
                </button>
            </div>

            <!-- Speed Control -->


            <div class="toolbar-spacer" style="flex-grow: 1;"></div>

            <!-- Zoom -->
            <!-- Zoom Removed -->

            <div class="toolbar-divider"></div>

            <!-- Selection Indicator -->
            <span class="selection-indicator" id="selection-count" style="display: none;">ÏÑ†ÌÉù: 0Í∞ú</span>

            <div class="toolbar-divider"></div>

            <!-- Utils -->
            <div class="toolbar-group">
                <button class="icon-btn btn-collaborate" id="btn-collaborate" onclick="toggleCollaboration()"
                    title="Ïã§ÏãúÍ∞Ñ ÌòëÏóÖ">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    <span class="btn-text">ÌòëÏóÖ</span>
                </button>
                <button class="icon-btn" onclick="showPublishModal()" title="ÌîÑÎ°úÏ†ùÌä∏ Í≥µÍ∞ú ÏÑ§Ï†ï">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="2" y1="12" x2="22" y2="12"></line>
                        <path
                            d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z">
                        </path>
                    </svg>
                    <span class="btn-text">Í≥µÍ∞ú</span>
                </button>
                <button class="icon-btn" onclick="sim.validator?.validateCircuit()" title="ÌöåÎ°ú Í≤ÄÏ¶ù">
                    <svg>
                        <use href="#icon-settings" />
                    </svg>
                    <span class="btn-text">Í≤ÄÏ¶ù</span>
                </button>
                <button class="icon-btn" onclick="sim.showTruthTable()" title="ÏßÑÎ¶¨Ìëú ÏÉùÏÑ±">
                    <svg>
                        <use href="#icon-chart" />
                    </svg>
                    <span class="btn-text">ÏßÑÎ¶¨Ìëú</span>
                </button>
                <button class="icon-btn" onclick="sim.showHelp()" title="ÎèÑÏõÄÎßê">
                    <svg>
                        <use href="#icon-help" />
                    </svg>
                    <span class="btn-text">ÎèÑÏõÄÎßê</span>
                </button>
                <button class="icon-btn" onclick="sim.openSettings()" title="ÏÑ§Ï†ï">
                    <svg>
                        <use href="#icon-settings" />
                    </svg>
                    <span class="btn-text">ÏÑ§Ï†ï</span>
                </button>
            </div>
        </header>

        <!-- ======== Sidebar ======== -->
        <aside class="sidebar" id="sidebar">
            <button class="sidebar-toggle-btn" onclick="sim.toggleSidebar()" title="ÏÇ¨Ïù¥ÎìúÎ∞î Ïó¥Í∏∞/Îã´Í∏∞">
                <svg width="12" height="12" viewBox="0 0 12 12">
                    <path d="M8 2 L4 6 L8 10" stroke="currentColor" stroke-width="2" fill="none"
                        stroke-linecap="round" />
                </svg>
            </button>

            <div class="sidebar-content">
                <!-- Account Status -->
                <div class="account-section">
                    <div class="account-avatar">üë§</div>
                    <div class="account-info">
                        <span class="account-name" id="account-name">Guest</span>
                        <span class="account-plan">Free Plan</span>
                    </div>
                </div>

                <!-- IO -->
                <section class="section" id="sec-io">
                    <div class="section-header" onclick="sim.toggleSection('sec-io')">
                        <span class="section-title">
                            <svg class="section-arrow">
                                <use href="#icon-chevron-down" />
                            </svg>
                            ÏûÖÏ∂úÎ†•
                        </span>
                    </div>
                    <div class="section-content">
                        <div class="comp-grid">
                            <button class="comp-btn io" onclick="sim.addModule('SWITCH')"
                                onmouseenter="sim.showTooltip('SWITCH'); sim.positionTooltip(event)"
                                onmouseleave="sim.hideTooltip()">
                                <div class="icon">
                                    <svg viewBox="0 0 44 44">
                                        <circle cx="22" cy="22" r="16" fill="none" stroke="#22c55e"
                                            stroke-width="2.5" />
                                        <line x1="22" y1="10" x2="22" y2="22" stroke="#22c55e" stroke-width="2.5"
                                            stroke-linecap="round" />
                                    </svg>
                                </div>
                                <span class="name">Ïä§ÏúÑÏπò</span>
                            </button>
                            <button class="comp-btn io" onclick="sim.addModule('LED')"
                                onmouseenter="sim.showTooltip('LED'); sim.positionTooltip(event)"
                                onmouseleave="sim.hideTooltip()">
                                <div class="icon">
                                    <svg viewBox="0 0 32 32">
                                        <circle cx="16" cy="16" r="11" fill="#ef4444" stroke="#fca5a5"
                                            stroke-width="2" />
                                    </svg>
                                </div>
                                <span class="name">LED</span>
                            </button>
                            <button class="comp-btn io" onclick="sim.addModule('CLOCK')"
                                onmouseenter="sim.showTooltip('CLOCK'); sim.positionTooltip(event)"
                                onmouseleave="sim.hideTooltip()">
                                <div class="icon">
                                    <svg viewBox="0 0 56 40">
                                        <rect x="6" y="8" width="44" height="24" rx="2" fill="none" stroke="#8b5cf6"
                                            stroke-width="2" />
                                        <polyline points="12,24 12,16 20,16 20,24 28,24 28,16 36,16 36,24 44,24 44,16"
                                            fill="none" stroke="#8b5cf6" stroke-width="2" stroke-linejoin="miter" />
                                    </svg>
                                </div>
                                <span class="name">ÌÅ¥Îü≠</span>
                            </button>
                        </div>
                    </div>
                </section>

                <!-- Gates -->
                <section class="section" id="sec-gates">
                    <div class="section-header" onclick="sim.toggleSection('sec-gates')">
                        <span class="section-title">
                            <svg class="section-arrow">
                                <use href="#icon-chevron-down" />
                            </svg>
                            ÎÖºÎ¶¨ Í≤åÏù¥Ìä∏
                        </span>
                        <span class="section-count">7</span>
                    </div>
                    <div class="section-content">
                        <div class="comp-grid">
                            <button class="comp-btn gate-and" onclick="sim.addModule('AND')"
                                onmouseenter="sim.showTooltip('AND'); sim.positionTooltip(event)"
                                onmouseleave="sim.hideTooltip()">
                                <div class="icon">
                                    <svg viewBox="0 0 48 32">
                                        <path d="M8 4 L24 4 A 12 14 0 0 1 24 28 L8 28 Z" fill="none" stroke="#3b82f6"
                                            stroke-width="2" />
                                    </svg>
                                </div>
                                <span class="name">AND</span>
                            </button>
                            <button class="comp-btn gate-or" onclick="sim.addModule('OR')"
                                onmouseenter="sim.showTooltip('OR'); sim.positionTooltip(event)"
                                onmouseleave="sim.hideTooltip()">
                                <div class="icon">
                                    <svg viewBox="0 0 48 32">
                                        <path d="M6 4 Q 14 16 6 28 Q 24 28 38 16 Q 24 4 6 4 Z" fill="none"
                                            stroke="#10b981" stroke-width="2" />
                                    </svg>
                                </div>
                                <span class="name">OR</span>
                            </button>
                            <button class="comp-btn gate-not" onclick="sim.addModule('NOT')"
                                onmouseenter="sim.showTooltip('NOT'); sim.positionTooltip(event)"
                                onmouseleave="sim.hideTooltip()">
                                <div class="icon">
                                    <svg viewBox="0 0 44 32">
                                        <path d="M6 4 L30 16 L6 28 Z" fill="none" stroke="#ef4444" stroke-width="2" />
                                        <circle cx="35" cy="16" r="4" fill="none" stroke="#ef4444" stroke-width="2" />
                                    </svg>
                                </div>
                                <span class="name">NOT</span>
                            </button>
                            <button class="comp-btn gate-nand" onclick="sim.addModule('NAND')"
                                onmouseenter="sim.showTooltip('NAND'); sim.positionTooltip(event)"
                                onmouseleave="sim.hideTooltip()">
                                <div class="icon">
                                    <svg viewBox="0 0 48 32">
                                        <path d="M6 4 L20 4 A 12 14 0 0 1 20 28 L6 28 Z" fill="none" stroke="#8b5cf6"
                                            stroke-width="2" />
                                        <circle cx="36" cy="16" r="4" fill="none" stroke="#8b5cf6" stroke-width="2" />
                                    </svg>
                                </div>
                                <span class="name">NAND</span>
                            </button>
                            <button class="comp-btn gate-nor" onclick="sim.addModule('NOR')"
                                onmouseenter="sim.showTooltip('NOR'); sim.positionTooltip(event)"
                                onmouseleave="sim.hideTooltip()">
                                <div class="icon">
                                    <svg viewBox="0 0 48 32">
                                        <path d="M4 4 Q 12 16 4 28 Q 20 28 32 16 Q 20 4 4 4 Z" fill="none"
                                            stroke="#f59e0b" stroke-width="2" />
                                        <circle cx="38" cy="16" r="4" fill="none" stroke="#f59e0b" stroke-width="2" />
                                    </svg>
                                </div>
                                <span class="name">NOR</span>
                            </button>
                            <button class="comp-btn gate-xor" onclick="sim.addModule('XOR')"
                                onmouseenter="sim.showTooltip('XOR'); sim.positionTooltip(event)"
                                onmouseleave="sim.hideTooltip()">
                                <div class="icon">
                                    <svg viewBox="0 0 48 32">
                                        <path d="M10 4 Q 18 16 10 28 Q 26 28 40 16 Q 26 4 10 4 Z" fill="none"
                                            stroke="#06b6d4" stroke-width="2" />
                                        <path d="M4 4 Q 12 16 4 28" fill="none" stroke="#06b6d4" stroke-width="2" />
                                    </svg>
                                </div>
                                <span class="name">XOR</span>
                            </button>
                            <button class="comp-btn gate-xnor" onclick="sim.addModule('XNOR')"
                                onmouseenter="sim.showTooltip('XNOR'); sim.positionTooltip(event)"
                                onmouseleave="sim.hideTooltip()">
                                <div class="icon">
                                    <svg viewBox="0 0 48 32">
                                        <path d="M10 4 Q 18 16 10 28 Q 24 28 34 16 Q 24 4 10 4 Z" fill="none"
                                            stroke="#ec4899" stroke-width="2" />
                                        <path d="M4 4 Q 12 16 4 28" fill="none" stroke="#ec4899" stroke-width="2" />
                                        <circle cx="40" cy="16" r="4" fill="none" stroke="#ec4899" stroke-width="2" />
                                    </svg>
                                </div>
                                <span class="name">XNOR</span>
                            </button>
                        </div>
                    </div>
                </section>

                <!-- Modules -->
                <section class="section" id="section-modules">
                    <div class="section-header" onclick="sim.toggleSection('section-modules')">
                        <span class="section-title">
                            <svg class="section-arrow">
                                <use href="#icon-chevron-down" />
                            </svg>
                            Modules
                        </span>
                    </div>
                    <div class="section-content">
                        <!-- Standard Packages Container -->
                        <div class="comp-grid" id="standard-packages">
                            <!-- JS will render basic modules here -->
                        </div>

                        <div class="comp-grid"
                            style="margin-top: 10px; border-top: 1px dashed rgba(255,255,255,0.1); padding-top: 10px;">
                            <button class="comp-btn dashed" onclick="sim.startNewModule()">
                                <div class="icon"><svg>
                                        <use href="#icon-plus" />
                                    </svg></div>
                                <span class="name">ÏÉà Î™®Îìà ÎßåÎì§Í∏∞</span>
                            </button>
                        </div>
                        <div id="user-packages" style="margin-top: 8px;"></div>
                    </div>
                </section>

                <!-- Transistors -->
                <section class="section" id="section-transistors">
                    <div class="section-header" onclick="sim.toggleSection('section-transistors')">
                        <span class="section-title">
                            <svg class="section-arrow">
                                <use href="#icon-chevron-down" />
                            </svg>
                            Transistors
                        </span>
                        <span class="section-count">4</span>
                    </div>
                    <div class="section-content">
                        <div class="comp-grid">
                            <button class="comp-btn trans-npn" onclick="sim.addModule('TRANSISTOR')"
                                onmouseenter="sim.showTooltip('TRANSISTOR'); sim.positionTooltip(event)"
                                onmouseleave="sim.hideTooltip()">
                                <div class="icon">
                                    <svg viewBox="0 0 48 48">
                                        <!-- NPN Transistor Symbol -->
                                        <line x1="16" y1="12" x2="16" y2="36" stroke="#06b6d4" stroke-width="2.5" />
                                        <line x1="16" y1="18" x2="32" y2="10" stroke="#06b6d4" stroke-width="2.5" />
                                        <line x1="16" y1="30" x2="32" y2="38" stroke="#06b6d4" stroke-width="2.5" />
                                        <polygon points="28,34 32,38 26,38" fill="#06b6d4" />
                                        <line x1="4" y1="24" x2="16" y2="24" stroke="#06b6d4" stroke-width="2" />
                                    </svg>
                                </div>
                                <span class="name">NPN</span>
                            </button>
                            <button class="comp-btn trans-pmos" onclick="sim.addModule('PMOS')"
                                onmouseenter="sim.showTooltip('PMOS'); sim.positionTooltip(event)"
                                onmouseleave="sim.hideTooltip()">
                                <div class="icon">
                                    <svg viewBox="0 0 48 48">
                                        <!-- PMOS Transistor Symbol -->
                                        <line x1="16" y1="12" x2="16" y2="36" stroke="#8b5cf6" stroke-width="2.5" />
                                        <line x1="16" y1="18" x2="32" y2="10" stroke="#8b5cf6" stroke-width="2.5" />
                                        <line x1="16" y1="30" x2="32" y2="38" stroke="#8b5cf6" stroke-width="2.5" />
                                        <polygon points="20,22 16,24 20,26" fill="#8b5cf6" />
                                        <line x1="4" y1="24" x2="16" y2="24" stroke="#8b5cf6" stroke-width="2" />
                                        <circle cx="12" cy="24" r="2" fill="none" stroke="#8b5cf6" stroke-width="1.5" />
                                    </svg>
                                </div>
                                <span class="name">PMOS</span>
                            </button>
                            <button class="comp-btn power-vcc" onclick="sim.addModule('VCC')"
                                onmouseenter="sim.showTooltip('VCC'); sim.positionTooltip(event)"
                                onmouseleave="sim.hideTooltip()">
                                <div class="icon">
                                    <svg viewBox="0 0 44 40">
                                        <!-- VCC: ÌôîÏÇ¥Ìëú Ïò§Î•∏Ï™Ω, ÏÑ† ÏôºÏ™Ω -->
                                        <line x1="0" y1="20" x2="24" y2="20" stroke="#ef4444" stroke-width="3" />
                                        <polygon points="40,20 24,10 24,30" fill="#ef4444" stroke="#ef4444"
                                            stroke-width="2" stroke-linejoin="round" />
                                    </svg>
                                </div>
                                <span class="name">VCC</span>
                            </button>
                            <button class="comp-btn power-gnd" onclick="sim.addModule('GND')"
                                onmouseenter="sim.showTooltip('GND'); sim.positionTooltip(event)"
                                onmouseleave="sim.hideTooltip()">
                                <div class="icon">
                                    <svg viewBox="0 0 44 40">
                                        <!-- GND: ÏÑ† ÏôºÏ™Ω, Ï†ëÏßÄ Ïã¨Î≥º Ïò§Î•∏Ï™Ω -->
                                        <line x1="0" y1="20" x2="24" y2="20" stroke="#94a3b8" stroke-width="3" />
                                        <line x1="24" y1="6" x2="24" y2="34" stroke="#94a3b8" stroke-width="3" />
                                        <line x1="32" y1="10" x2="32" y2="30" stroke="#94a3b8" stroke-width="2.5" />
                                        <line x1="40" y1="14" x2="40" y2="26" stroke="#94a3b8" stroke-width="2" />
                                    </svg>
                                </div>
                                <span class="name">GND</span>
                            </button>
                        </div>
                    </div>
                </section>

                <!-- Advanced Components -->
                <section class="section" id="section-advanced">
                    <div class="section-header" onclick="sim.toggleSection('section-advanced')">
                        <span class="section-title">
                            <svg class="section-arrow">
                                <use href="#icon-chevron-down" />
                            </svg>
                            üîß Í≥†Í∏â Î∂ÄÌíà
                        </span>
                        <span class="section-count">3</span>
                    </div>
                    <div class="section-content">
                        <div class="comp-grid">
                            <button class="comp-btn" style="background: linear-gradient(135deg, #1a1a2e, #16213e);"
                                onclick="sim.add7SegmentDisplay && sim.add7SegmentDisplay()"
                                onmouseenter="sim.showTooltip('7-Segment Display', '4ÎπÑÌä∏ BCD ÏûÖÎ†•ÏùÑ Î∞õÏïÑ 0~F Ïà´ÏûêÎ•º ÌëúÏãúÌï©ÎãàÎã§.'); sim.positionTooltip(event)"
                                onmouseleave="sim.hideTooltip()">
                                <div class="icon" style="font-size: 24px; color: #ef4444;">8.</div>
                                <span class="name">7-Seg</span>
                            </button>
                            <button class="comp-btn" style="background: linear-gradient(135deg, #4a0080, #2d0050);"
                                onclick="sim.add4BitCounter && sim.add4BitCounter()"
                                onmouseenter="sim.showTooltip('4-Bit Counter', 'CLK ÏÉÅÏäπ Ïó£ÏßÄÏóêÏÑú 0~15Î•º ÏàúÌôòÌï©ÎãàÎã§.'); sim.positionTooltip(event)"
                                onmouseleave="sim.hideTooltip()">
                                <div class="icon" style="font-size: 18px; color: #00ff88;">‚è±Ô∏è</div>
                                <span class="name">Ïπ¥Ïö¥ÌÑ∞</span>
                            </button>
                            <button class="comp-btn" style="background: linear-gradient(135deg, #2c3e50, #1a252f);"
                                onclick="sim.add4x4Keypad && sim.add4x4Keypad()"
                                onmouseenter="sim.showTooltip('4x4 Keypad', '0~F ÌÇ§Î•º Ï†úÍ≥µÌïòÎäî 16ÌÇ§ ÏûÖÎ†•Ïû•Ïπò'); sim.positionTooltip(event)"
                                onmouseleave="sim.hideTooltip()">
                                <div class="icon" style="font-size: 18px;">‚å®Ô∏è</div>
                                <span class="name">ÌÇ§Ìå®Îìú</span>
                            </button>
                        </div>
                    </div>
                </section>

                <!-- Tools & Analysis -->
                <section class="section" id="section-tools">
                    <div class="section-header" onclick="sim.toggleSection('section-tools')">
                        <span class="section-title">
                            <svg class="section-arrow">
                                <use href="#icon-chevron-down" />
                            </svg>
                            üìä Î∂ÑÏÑù ÎèÑÍµ¨
                        </span>
                    </div>
                    <div class="section-content">
                        <div class="comp-grid">
                            <button class="comp-btn" style="background: linear-gradient(135deg, #0ea5e9, #0369a1);"
                                onclick="sim.showTimingPanel && sim.showTimingPanel()" title="ÌÉÄÏù¥Î∞ç Îã§Ïù¥Ïñ¥Í∑∏Îû®">
                                <div class="icon" style="font-size: 18px;">üìà</div>
                                <span class="name">ÌÉÄÏù¥Î∞ç</span>
                            </button>
                            <button class="comp-btn" style="background: linear-gradient(135deg, #8b5cf6, #6d28d9);"
                                onclick="sim.showPuzzlePanel && sim.showPuzzlePanel()" title="ÌçºÏ¶ê Î™®Îìú">
                                <div class="icon" style="font-size: 18px;">üß©</div>
                                <span class="name">ÌçºÏ¶ê</span>
                            </button>
                        </div>
                    </div>
                </section>
            </div>
        </aside>

        <!-- ======== Workspace with Tabs ======== -->
        <main class="workspace-wrapper">
            <!-- Tab Bar -->
            <div class="workspace-tabs" id="workspace-tabs">
                <div class="tab active" data-tab="main" onclick="sim.switchTab('main')">
                    <span class="tab-icon"><svg>
                            <use href="#icon-wire" />
                        </svg></span>
                    <span class="tab-title">Î©îÏù∏ ÌöåÎ°ú</span>
                </div>
                <div class="tab" data-tab="module" id="module-tab" style="display: none;"
                    onclick="sim.switchTab('module')">
                    <span class="tab-icon"><svg>
                            <use href="#icon-package" />
                        </svg></span>
                    <span class="tab-title" id="module-tab-title">Î™®Îìà Ìé∏Ïßë</span>
                    <button class="tab-close" onclick="event.stopPropagation(); sim.closeModuleTab()">√ó</button>
                </div>
            </div>

            <!-- Main Circuit Workspace -->
            <div id="workspace" class="workspace-content active">
                <svg id="wire-layer"></svg>
            </div>

            <!-- Module Editor Workspace (Hidden by default) -->
            <div id="module-workspace" class="workspace-content module-editor" style="display: none;">
                <div class="module-editor-header">
                    <div class="module-info">
                        <input type="text" class="module-name-input" id="editing-module-name" value="ÏÉà Î™®Îìà"
                            placeholder="Î™®Îìà Ïù¥Î¶Ñ ÏûÖÎ†•">
                        <span class="module-desc">ÏÜåÏûêÎ•º Î∞∞ÏπòÌïòÍ≥† ÏûÖÏ∂úÎ†• Ìè¨Ìä∏Î•º Ïó∞Í≤∞ÌïòÏÑ∏Ïöî</span>
                    </div>
                    <div class="module-actions">
                        <button class="btn-module-action save" id="btn-save-as-new" onclick="sim.saveAsNewModule()">
                            Î™®ÎìàÎ°ú Ï†ÄÏû•
                        </button>
                        <button class="btn-module-action" id="btn-save-changes" onclick="sim.saveModuleChanges()"
                            style="display: none;">
                            Î≥ÄÍ≤ΩÏÇ¨Ìï≠ Ï†ÄÏû•
                        </button>
                        <button class="btn-module-action secondary" onclick="sim.closeModuleTab()">
                            Îã´Í∏∞
                        </button>
                    </div>
                </div>

                <div class="module-editor-body">
                    <!-- Component Palette for Module -->
                    <div class="module-palette">
                        <div class="palette-section">
                            <h5>ÏûÖÏ∂úÎ†•</h5>
                            <div class="palette-grid">
                                <button class="palette-btn input" onclick="sim.addModuleComponent('PORT_IN')"
                                    title="ÏûÖÎ†• Ìè¨Ìä∏">
                                    <span class="icon">‚Üí</span>
                                    <span class="label">ÏûÖÎ†•</span>
                                </button>
                                <button class="palette-btn output" onclick="sim.addModuleComponent('PORT_OUT')"
                                    title="Ï∂úÎ†• Ìè¨Ìä∏">
                                    <span class="icon">‚Üí</span>
                                    <span class="label">Ï∂úÎ†•</span>
                                </button>
                            </div>
                        </div>
                        <div class="palette-section">
                            <h5>‚ö° Í≤åÏù¥Ìä∏</h5>
                            <div class="palette-grid">
                                <button class="palette-btn" onclick="sim.addModuleComponent('AND')"
                                    title="AND Í≤åÏù¥Ìä∏">AND</button>
                                <button class="palette-btn" onclick="sim.addModuleComponent('OR')"
                                    title="OR Í≤åÏù¥Ìä∏">OR</button>
                                <button class="palette-btn" onclick="sim.addModuleComponent('NOT')"
                                    title="NOT Í≤åÏù¥Ìä∏">NOT</button>
                                <button class="palette-btn" onclick="sim.addModuleComponent('NAND')"
                                    title="NAND Í≤åÏù¥Ìä∏">NAND</button>
                                <button class="palette-btn" onclick="sim.addModuleComponent('NOR')"
                                    title="NOR Í≤åÏù¥Ìä∏">NOR</button>
                                <button class="palette-btn" onclick="sim.addModuleComponent('XOR')"
                                    title="XOR Í≤åÏù¥Ìä∏">XOR</button>
                                <button class="palette-btn" onclick="sim.addModuleComponent('XNOR')"
                                    title="XNOR Í≤åÏù¥Ìä∏">XNOR</button>
                            </div>
                        </div>
                        <div class="palette-section">
                            <h5>üìä ÌòÑÏû¨ Î™®Îìà Ï†ïÎ≥¥</h5>
                            <div class="module-stats">
                                <div class="stat-row">
                                    <span>ÏûÖÎ†•:</span>
                                    <span id="module-input-count">0</span>
                                </div>
                                <div class="stat-row">
                                    <span>Ï∂úÎ†•:</span>
                                    <span id="module-output-count">0</span>
                                </div>
                                <div class="stat-row">
                                    <span>Í≤åÏù¥Ìä∏:</span>
                                    <span id="module-gate-count">0</span>
                                </div>
                            </div>
                        </div>
                        <div class="palette-section">
                            <h5>Ìå®ÌÇ§ÏßÄ ÌÅ¨Í∏∞</h5>
                            <div class="size-inputs">
                                <div class="size-row">
                                    <label>ÎÑàÎπÑ:</label>
                                    <input type="number" id="module-width" value="90" min="60" max="200" step="10">
                                </div>
                                <div class="size-row">
                                    <label>ÎÜíÏù¥:</label>
                                    <input type="number" id="module-height" value="60" min="40" max="200" step="10">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Module Canvas -->
                    <div class="module-canvas" id="module-canvas">
                        <svg id="module-wire-layer"></svg>
                    </div>
                </div>

                <!-- Module I/O Summary Panel -->
                <div class="module-io-panel">
                    <div class="io-section">
                        <h4>üì• ÏûÖÎ†• Ìè¨Ìä∏</h4>
                        <div id="module-inputs" class="io-list"></div>
                    </div>
                    <div class="io-section">
                        <h4>üì§ Ï∂úÎ†• Ìè¨Ìä∏</h4>
                        <div id="module-outputs" class="io-list"></div>
                    </div>
                    <div class="io-section wide">
                        <h4>ÎèÑÏõÄÎßê</h4>
                        <p class="io-help">ÏûÖÎ†•/Ï∂úÎ†• Ìè¨Ìä∏Î•º Î∞∞ÏπòÌïòÍ≥† Í≤åÏù¥Ìä∏Î°ú Ïó∞Í≤∞ÌïòÏÑ∏Ïöî. ÌïÄÏùÑ ÌÅ¥Î¶≠ÌïòÏó¨ ÏôÄÏù¥Ïñ¥Î•º Ïó∞Í≤∞Ìï©ÎãàÎã§.</p>
                    </div>
                </div>
            </div>

            <div class="minimap" id="minimap">
                <div class="minimap-viewport" id="minimap-viewport"></div>
            </div>
        </main>

        <!-- Selection Box (body ÏßÅÏ†ë ÏûêÏãùÏúºÎ°ú Ïù¥Îèô - transform containing block Î¨∏Ï†ú Ìï¥Í≤∞) -->
        <div id="selection-box"></div>

        <!-- Component Info Panel (Ï¢åÏ∏° ÏÉÅÎã® - ÎèÖÎ¶ΩÏ†Å ÏúÑÏπò) -->
        <div id="component-info-panel" class="component-info-panel hidden">
            <div class="info-header">
                <span class="info-type-icon"><svg width="16" height="16">
                        <use href="#icon-wire" />
                    </svg></span>
                <span class="info-type-name">Component</span>
            </div>
            <!-- Ïï†ÎãàÎ©îÏù¥ÏÖò ÏòÅÏó≠ -->
            <div class="info-animation" id="info-animation">
                <!-- SVG Ïï†ÎãàÎ©îÏù¥ÏÖòÏù¥ Ïó¨Í∏∞Ïóê ÏÇΩÏûÖÎê® -->
            </div>
            <div class="info-body">
                <p class="info-description">ÏÜåÏûêÎ•º ÏÑ†ÌÉùÌïòÎ©¥ Ïó¨Í∏∞Ïóê ÏÑ§Î™ÖÏù¥ ÌëúÏãúÎê©ÎãàÎã§.</p>
                <!-- ÏÇ¨Ïö©Î≤ï ÏòÅÏó≠ -->
                <div class="info-usage" id="info-usage-section">
                    <div class="info-usage-title">Tip</div>
                    <p class="info-usage-content" id="info-usage"></p>
                </div>
                <div class="info-details">
                    <div class="info-row">
                        <span class="info-label">ÏûÖÎ†•:</span>
                        <span class="info-value" id="info-inputs">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Ï∂úÎ†•:</span>
                        <span class="info-value" id="info-outputs">-</span>
                    </div>
                </div>
                <div class="info-truth-table" id="info-truth-table" style="display: none;">
                    <span class="info-label">ÏßÑÎ¶¨Ìëú:</span>
                    <table class="truth-table"></table>
                </div>
            </div>
        </div>

        <!-- ======== Status Bar ======== -->
        <footer class="statusbar">
            <div class="status-left">
                <span id="status-components" class="status-item">Î∂ÄÌíà: 0</span>
                <span id="status-wires" class="status-item">Ï†ÑÏÑ†: 0</span>
            </div>

            <!-- Enhanced Speed Control Pill -->
            <div class="status-center">
                <div class="speed-control-pill">
                    <div class="speed-icon"><svg>
                            <use href="#icon-lightning" />
                        </svg></div>
                    <span class="speed-label">ÏÜçÎèÑ</span>
                    <input type="range" id="sim-speed" class="speed-slider" min="0.1" max="10" step="0.1" value="1.0"
                        oninput="sim.setSimulationSpeed(parseFloat(this.value))">
                    <span class="speed-value" id="speed-value">1.0x</span>
                </div>
            </div>

            <div class="status-right">
                <button class="icon-btn feedback-btn" onclick="openFeedbackModal()" title="ÌîºÎìúÎ∞± Î≥¥ÎÇ¥Í∏∞">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                    </svg>
                    <span class="btn-text">ÌîºÎìúÎ∞±</span>
                </button>
            </div>
        </footer>
    </div>

    <!-- ======== Context Menu ======== -->
    <div id="context-menu">
        <div class="ctx-item" onclick="sim.copySelection()">
            <svg>
                <use href="#icon-copy" />
            </svg>
            Î≥µÏÇ¨
            <span class="shortcut">Ctrl+C</span>
        </div>
        <div class="ctx-item" onclick="sim.pasteFromClipboard()">
            <svg>
                <use href="#icon-paste" />
            </svg>
            Î∂ôÏó¨ÎÑ£Í∏∞
            <span class="shortcut">Ctrl+V</span>
        </div>
        <div class="ctx-item" onclick="sim.duplicateSelection()">
            <svg>
                <use href="#icon-duplicate" />
            </svg>
            Î≥µÏ†ú
            <span class="shortcut">Ctrl+D</span>
        </div>
        <div class="ctx-sep"></div>
        <!-- LED Color Options -->
        <div class="ctx-item ctx-led-only" onclick="sim.setLEDColor('red')">
            <span style="color:#ef4444;">‚óè</span> Îπ®Í∞ï LED
        </div>
        <div class="ctx-item ctx-led-only" onclick="sim.setLEDColor('green')">
            <span style="color:#22c55e;">‚óè</span> Ï¥àÎ°ù LED
        </div>
        <div class="ctx-item ctx-led-only" onclick="sim.setLEDColor('blue')">
            <span style="color:#3b82f6;">‚óè</span> ÌååÎûë LED
        </div>
        <div class="ctx-item ctx-led-only" onclick="sim.setLEDColor('yellow')">
            <span style="color:#eab308;">‚óè</span> ÎÖ∏Îûë LED
        </div>
        <div class="ctx-item ctx-led-only" onclick="sim.setLEDColor('white')">
            <span style="color:#f8fafc;">‚óè</span> Ìù∞ÏÉâ LED
        </div>
        <div class="ctx-sep ctx-led-only"></div>
        <!-- Alignment Tools -->
        <div class="ctx-item" onclick="sim.alignSelectedHorizontal()">
            <svg viewBox="0 0 24 24">
                <line x1="12" y1="4" x2="12" y2="20" stroke="currentColor" stroke-width="2" />
                <line x1="4" y1="12" x2="20" y2="12" stroke="currentColor" stroke-width="2" />
            </svg>
            ÏàòÌèâ Ï†ïÎ†¨
        </div>
        <div class="ctx-item" onclick="sim.alignSelectedVertical()">
            <svg viewBox="0 0 24 24">
                <line x1="4" y1="12" x2="20" y2="12" stroke="currentColor" stroke-width="2" />
                <line x1="12" y1="4" x2="12" y2="20" stroke="currentColor" stroke-width="2" />
            </svg>
            ÏàòÏßÅ Ï†ïÎ†¨
        </div>
        <div class="ctx-item" onclick="sim.distributeHorizontal()">
            ‚¨å ÏàòÌèâ Í∑†Îì±
        </div>
        <div class="ctx-item" onclick="sim.distributeVertical()">
            ‚¨ç ÏàòÏßÅ Í∑†Îì±
        </div>
        <div class="ctx-sep"></div>
        <!-- Rotate & Flip -->
        <div class="ctx-item" onclick="sim.rotateSelected()">
            <svg viewBox="0 0 24 24">
                <path d="M23 4v6h-6M1 20v-6h6" stroke="currentColor" stroke-width="2" fill="none" />
                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15" stroke="currentColor"
                    stroke-width="2" fill="none" />
            </svg>
            ÌöåÏ†Ñ
            <span class="shortcut">R</span>
        </div>
        <div class="ctx-item" onclick="sim.flipHorizontal()">
            ‚ÜîÔ∏è Ï¢åÏö∞ Î∞òÏ†Ñ
        </div>
        <div class="ctx-item" onclick="sim.flipVertical()">
            ‚ÜïÔ∏è ÏÉÅÌïò Î∞òÏ†Ñ
        </div>
        <div class="ctx-sep"></div>
        <!-- ÌÉÄÏù¥Î∞ç Ï∂îÏ†Å -->
        <div class="ctx-item"
            onclick="if(sim.selectedComponents.length === 1 && sim.addComponentToTiming) sim.addComponentToTiming(sim.selectedComponents[0])">
            üìà ÌÉÄÏù¥Î∞ç Ï∂îÏ†Å
        </div>
        <div class="ctx-item danger" onclick="sim.deleteSelected()">
            <svg>
                <use href="#icon-trash" />
            </svg>
            ÏÇ≠Ï†ú
            <span class="shortcut">Del</span>
        </div>
    </div>

    <!-- ======== Interactive Tooltip Panel ======== -->
    <div id="tooltip" class="tooltip-panel">
        <div class="tooltip-header">
            <div class="tooltip-icon" id="tooltip-icon"></div>
            <div class="tooltip-title-area">
                <div id="tooltip-title" class="tooltip-title"></div>
                <div id="tooltip-type" class="tooltip-type"></div>
            </div>
        </div>
        <div class="tooltip-animation" id="tooltip-animation">
            <!-- SVG animation will be inserted here -->
        </div>
        <div class="tooltip-content">
            <div id="tooltip-desc" class="tooltip-desc"></div>
            <div class="tooltip-usage">
                <div class="tooltip-usage-title">Tip</div>
                <div id="tooltip-usage" class="tooltip-usage-content"></div>
            </div>
            <div class="tooltip-shortcuts" id="tooltip-shortcuts"></div>
        </div>
    </div>

    <!-- ======== Help Modal ======== -->
    <div class="modal-overlay" id="help-modal">
        <div class="modal" style="max-width: 560px;">
            <div class="modal-header">
                <h2 class="modal-title">Keyboard Shortcuts</h2>
                <button class="modal-close" onclick="document.getElementById('help-modal').classList.remove('show')">
                    <svg width="16" height="16">
                        <use href="#icon-close" />
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="shortcuts-grid">
                    <div class="shortcut-item"><span class="shortcut-key">V</span><span class="shortcut-desc">Select
                            Tool</span></div>
                    <div class="shortcut-item"><span class="shortcut-key">H</span><span class="shortcut-desc">Pan
                            Tool</span></div>
                    <div class="shortcut-item"><span class="shortcut-key">W</span><span class="shortcut-desc">Wire
                            Tool</span></div>
                    <div class="shortcut-item"><span class="shortcut-key">Space</span><span class="shortcut-desc">Temp
                            Pan</span></div>
                    <div class="shortcut-item"><span class="shortcut-key">Del</span><span
                            class="shortcut-desc">Delete</span></div>
                    <div class="shortcut-item"><span class="shortcut-key">Esc</span><span
                            class="shortcut-desc">Deselect</span></div>
                    <div class="shortcut-item"><span class="shortcut-key">Ctrl+A</span><span
                            class="shortcut-desc">Select All</span></div>
                    <div class="shortcut-item"><span class="shortcut-key">Ctrl+C</span><span
                            class="shortcut-desc">Copy</span></div>
                    <div class="shortcut-item"><span class="shortcut-key">Ctrl+V</span><span
                            class="shortcut-desc">Paste</span></div>
                    <div class="shortcut-item"><span class="shortcut-key">Ctrl+D</span><span
                            class="shortcut-desc">Duplicate</span></div>
                    <div class="shortcut-item"><span class="shortcut-key">Ctrl+S</span><span
                            class="shortcut-desc">Save</span></div>
                    <div class="shortcut-item"><span class="shortcut-key">Ctrl+Z</span><span
                            class="shortcut-desc">Undo</span></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary"
                    onclick="document.getElementById('help-modal').classList.remove('show')">Close</button>
            </div>
        </div>
    </div>

    <!-- ======== Truth Table Modal ======== -->
    <div class="modal-overlay" id="truth-table-modal">
        <div class="modal" style="max-width: 640px;">
            <div class="modal-header">
                <h2 class="modal-title">Truth Table</h2>
                <button class="modal-close"
                    onclick="document.getElementById('truth-table-modal').classList.remove('show')">
                    <svg width="16" height="16">
                        <use href="#icon-close" />
                    </svg>
                </button>
            </div>
            <div class="modal-body" id="truth-table-content">
                <p style="color: var(--text-muted); text-align: center; padding: 32px;">
                    Add switches and LEDs to generate a truth table.
                </p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-ghost" onclick="sim.exportTruthTable()">
                    <svg width="14" height="14">
                        <use href="#icon-download" />
                    </svg>
                    Export CSV
                </button>
                <button class="btn btn-primary" onclick="sim.generateTruthTable()">Generate</button>
            </div>
        </div>
    </div>

    <!-- ======== New Project Modal ======== -->
    <div class="modal-overlay" id="new-project-modal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">New Project</h2>
                <button class="modal-close"
                    onclick="document.getElementById('new-project-modal').classList.remove('show')">
                    <svg width="16" height="16">
                        <use href="#icon-close" />
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">ÌîÑÎ°úÏ†ùÌä∏ Ïù¥Î¶Ñ (Project Name)</label>
                    <input type="text" class="form-input" id="new-proj-name" placeholder="ÎÇòÏùò ÌöåÎ°ú">
                </div>
                <div class="form-row" style="display: flex; gap: 16px; margin-top: 16px;">
                    <div class="form-group" style="flex: 1;">
                        <label class="form-label">ÎÑàÎπÑ (Width)</label>
                        <input type="number" class="form-input" id="new-proj-width" value="3000" step="100">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label class="form-label">ÎÜíÏù¥ (Height)</label>
                        <input type="number" class="form-input" id="new-proj-height" value="2000" step="100">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-ghost"
                    onclick="document.getElementById('new-project-modal').classList.remove('show')">Cancel</button>
                <button class="btn btn-primary" onclick="sim.confirmNewProject()">Create</button>
            </div>
        </div>
    </div>

    <!-- ======== Feedback Floating Button & Modal ======== -->
    <!-- FAB Removed -->

    <div class="modal-overlay" id="feedback-modal">
        <div class="modal feedback-modal">
            <div class="modal-header">
                <h2 class="modal-title">üí¨ ÌîºÎìúÎ∞± Î≥¥ÎÇ¥Í∏∞</h2>
                <button class="modal-close" onclick="closeFeedbackModal()">
                    <svg width="16" height="16">
                        <use href="#icon-close" />
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <p style="color: var(--text-muted); margin-bottom: 20px; font-size: 14px;">
                    LoCADÎ•º ÏÇ¨Ïö©Ìï¥Ï£ºÏÖîÏÑú Í∞êÏÇ¨Ìï©ÎãàÎã§!<br>
                    Î≤ÑÍ∑∏ Î¶¨Ìè¨Ìä∏, Í∏∞Îä• Ï†úÏïà, ÎòêÎäî ÏùòÍ≤¨ÏùÑ ÏûêÏú†Î°≠Í≤å ÎÇ®Í≤®Ï£ºÏÑ∏Ïöî.
                </p>
                <div class="form-group">
                    <label class="form-label">Ïπ¥ÌÖåÍ≥†Î¶¨</label>
                    <select id="feedback-category" class="form-input" style="width: 100%;">
                        <option value="bug">üêõ Î≤ÑÍ∑∏ Î¶¨Ìè¨Ìä∏</option>
                        <option value="feature">Í∏∞Îä• Ï†úÏïà</option>
                        <option value="ux">üé® UI/UX Í∞úÏÑ†</option>
                        <option value="other">üìù Í∏∞ÌÉÄ ÏùòÍ≤¨</option>
                    </select>
                </div>
                <div class="form-group" style="margin-top: 16px;">
                    <label class="form-label">ÎÇ¥Ïö©</label>
                    <textarea id="feedback-content" class="form-input"
                        style="width: 100%; min-height: 120px; resize: vertical;"
                        placeholder="Ïó¨Í∏∞Ïóê ÌîºÎìúÎ∞±ÏùÑ ÏûëÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî..."></textarea>
                </div>
                <div class="form-group" style="margin-top: 12px;">
                    <label class="form-label">üì∑ Ïä§ÌÅ¨Î¶∞ÏÉ∑ Ï≤®Î∂Ä (ÏÑ†ÌÉù)</label>
                    <div style="display: flex; gap: 10px; align-items: center; margin-top: 8px;">
                        <input type="file" id="feedback-screenshot" accept="image/*" style="display: none;">
                        <button class="btn btn-ghost" onclick="document.getElementById('feedback-screenshot').click()"
                            style="padding: 8px 12px;">
                            üìÅ Ïù¥ÎØ∏ÏßÄ ÏÑ†ÌÉù
                        </button>
                        <button class="btn btn-ghost" onclick="captureScreenshot()" style="padding: 8px 12px;">
                            üì∏ ÌôîÎ©¥ Ï∫°Ï≤ò
                        </button>
                        <span id="screenshot-filename" style="color: var(--text-muted); font-size: 12px;"></span>
                    </div>
                    <div id="screenshot-preview" style="margin-top: 10px; display: none;">
                        <img id="screenshot-img"
                            style="max-width: 100%; max-height: 150px; border-radius: 8px; border: 1px solid var(--border);">
                        <button onclick="clearScreenshot()"
                            style="display: block; margin-top: 5px; font-size: 11px; color: var(--error); background: none; border: none; cursor: pointer;">‚ùå
                            Ï†úÍ±∞</button>
                    </div>
                </div>
                <div class="form-group" style="margin-top: 12px;">
                    <label class="form-label" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="feedback-include-circuit" checked>
                        ÌòÑÏû¨ ÌöåÎ°ú ÏÉÅÌÉú Ï≤®Î∂Ä (ÎîîÎ≤ÑÍπÖÏóê ÎèÑÏõÄÎê©ÎãàÎã§)
                    </label>
                </div>
                <!-- ÏóêÎü¨ Ï†ïÎ≥¥ Ïà®ÍπÄ ÌïÑÎìú -->
                <input type="hidden" id="feedback-error-info" value="">
                <div class="modal-footer">
                    <button class="btn btn-ghost" onclick="closeFeedbackModal()">Ï∑®ÏÜå</button>
                    <button class="btn btn-primary" onclick="submitFeedback()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <line x1="22" y1="2" x2="11" y2="13"></line>
                            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                        </svg>
                        Î≥¥ÎÇ¥Í∏∞
                    </button>
                </div>
            </div>
        </div>

        <style>

        </style>

        <script>
            // === ÌîºÎìúÎ∞± Î™®Îã¨ Ìï®Ïàò ===
            let screenshotDataUrl = null;

            function showFeedbackModal() {
                document.getElementById('feedback-modal').classList.add('show');
            }

            function closeFeedbackModal() {
                document.getElementById('feedback-modal').classList.remove('show');
                document.getElementById('feedback-content').value = '';
                document.getElementById('feedback-error-info').value = '';
                clearScreenshot();
            }

            // Ïä§ÌÅ¨Î¶∞ÏÉ∑ ÌååÏùº ÏÑ†ÌÉù Ï≤òÎ¶¨
            document.addEventListener('DOMContentLoaded', () => {
                const fileInput = document.getElementById('feedback-screenshot');
                if (fileInput) {
                    fileInput.addEventListener('change', (e) => {
                        const file = e.target.files[0];
                        if (file) {
                            const reader = new FileReader();
                            reader.onload = (event) => {
                                screenshotDataUrl = event.target.result;
                                showScreenshotPreview(screenshotDataUrl, file.name);
                            };
                            reader.readAsDataURL(file);
                        }
                    });
                }
            });

            function showScreenshotPreview(dataUrl, filename) {
                document.getElementById('screenshot-img').src = dataUrl;
                document.getElementById('screenshot-preview').style.display = 'block';
                document.getElementById('screenshot-filename').textContent = filename || 'üì∑ Ï∫°Ï≤òÎê®';
            }

            function clearScreenshot() {
                screenshotDataUrl = null;
                document.getElementById('screenshot-preview').style.display = 'none';
                document.getElementById('screenshot-filename').textContent = '';
                const fileInput = document.getElementById('feedback-screenshot');
                if (fileInput) fileInput.value = '';
            }

            async function captureScreenshot() {
                try {
                    // html2canvas ÎùºÏù¥Î∏åÎü¨Î¶¨ ÏÇ¨Ïö© ÎòêÎäî Canvas API
                    const workspace = document.getElementById('workspace');
                    if (!workspace) {
                        alert('Ï∫°Ï≤òÌï† ÌôîÎ©¥ÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                        return;
                    }

                    // Í∞ÑÎã®Ìïú Ï∫îÎ≤ÑÏä§ Ï∫°Ï≤ò (ÏãúÎÆ¨Î†àÏù¥ÌÑ∞ ÏòÅÏó≠)
                    const canvas = document.createElement('canvas');
                    const rect = workspace.getBoundingClientRect();
                    canvas.width = rect.width;
                    canvas.height = rect.height;

                    // SVGÎ•º Ìè¨Ìï®Ìïú Ï∫°Ï≤òÎäî Î≥µÏû°ÌïòÎØÄÎ°ú ÏïåÎ¶º
                    alert('üì∏ ÌòÑÏû¨ ÌôîÎ©¥ÏùÑ Ï∫°Ï≤òÌïòÎ†§Î©¥ ÌÇ§Î≥¥ÎìúÏùò Print Screen ÌÇ§Î•º ÎàÑÎ•¥Í≥†,\nÏù¥ÎØ∏ÏßÄ Ìé∏ÏßëÍ∏∞Ïóê Î∂ôÏó¨ÎÑ£Í∏∞(Ctrl+V) ÌõÑ Ï†ÄÏû•ÌïòÏó¨ Ï≤®Î∂ÄÌï¥Ï£ºÏÑ∏Ïöî.\n\nÎòêÎäî "Ïù¥ÎØ∏ÏßÄ ÏÑ†ÌÉù" Î≤ÑÌäºÏúºÎ°ú Ïä§ÌÅ¨Î¶∞ÏÉ∑ ÌååÏùºÏùÑ Ï≤®Î∂ÄÌïòÏÑ∏Ïöî.');
                } catch (error) {
                    console.error('Screenshot error:', error);
                    alert('Ïä§ÌÅ¨Î¶∞ÏÉ∑ Ï∫°Ï≤òÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. "Ïù¥ÎØ∏ÏßÄ ÏÑ†ÌÉù" Î≤ÑÌäºÏùÑ ÏÇ¨Ïö©Ìï¥Ï£ºÏÑ∏Ïöî.');
                }
            }

            async function submitFeedback() {
                const category = document.getElementById('feedback-category').value;
                const content = document.getElementById('feedback-content').value.trim();
                const includeCircuit = document.getElementById('feedback-include-circuit')?.checked;
                const errorInfo = document.getElementById('feedback-error-info')?.value || '';

                if (!content) {
                    alert('ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.');
                    return;
                }

                try {
                    const user = window.sb ? await window.sb.auth.getUser() : null;
                    const userEmail = user?.data?.user?.email || 'anonymous';

                    // ÌöåÎ°ú ÏÉÅÌÉú Ï≤®Î∂Ä (ÏÑ†ÌÉù Ïãú)
                    let circuitData = null;
                    if (includeCircuit && window.sim) {
                        try {
                            circuitData = JSON.stringify(window.sim.currentProjectData || {});
                        } catch (e) {
                            console.warn('Could not serialize circuit:', e);
                        }
                    }

                    // ÌîºÎìúÎ∞± Îç∞Ïù¥ÌÑ∞
                    const feedbackData = {
                        category: category,
                        content: content + (errorInfo ? `\n\n--- ÏóêÎü¨ Ï†ïÎ≥¥ ---\n${errorInfo}` : ''),
                        user_email: userEmail,
                        circuit_data: circuitData,
                        page_url: window.location.href,
                        screenshot_url: screenshotDataUrl || null,
                        created_at: new Date().toISOString()
                    };

                    await window.sb.from('feedback').insert(feedbackData);

                    alert('‚úì ÌîºÎìúÎ∞±Ïù¥ Ï†ÑÏÜ°ÎêòÏóàÏäµÎãàÎã§. Í∞êÏÇ¨Ìï©ÎãàÎã§!');
                    closeFeedbackModal();
                } catch (error) {
                    console.error('Feedback error:', error);
                    alert('ÌîºÎìúÎ∞± Ï†ÑÏÜ°Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.');
                }
            }

            // === ÏóêÎü¨ Î∞úÏÉù Ïãú ÏûêÎèô ÌîºÎìúÎ∞± Ï†úÏïà ===
            function showErrorFeedbackPrompt(errorMessage, errorStack) {
                const shouldSend = confirm(
                    `‚ùå Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.\n\n` +
                    `${errorMessage}\n\n` +
                    `Í∞úÎ∞úÏûêÏóêÍ≤å Ïù¥ Ïò§Î•òÎ•º Î≥¥Í≥†ÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n` +
                    `(ÌîºÎìúÎ∞± Ï∞ΩÏù¥ Ïó¥Î¶ΩÎãàÎã§)`
                );

                if (shouldSend) {
                    // ÏóêÎü¨ Ï†ïÎ≥¥Î•º ÌîºÎìúÎ∞± Î™®Îã¨Ïóê ÎØ∏Î¶¨ Ï±ÑÏö∞Í∏∞
                    document.getElementById('feedback-category').value = 'bug';
                    document.getElementById('feedback-content').value =
                        `[ÏûêÎèô Ïò§Î•ò Î≥¥Í≥†]\n\nÏò§Î•ò Î©îÏãúÏßÄ: ${errorMessage}\n\nÏ∂îÍ∞Ä ÏÑ§Î™ÖÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî:`;
                    document.getElementById('feedback-error-info').value =
                        `Error: ${errorMessage}\nStack: ${errorStack || 'N/A'}\nURL: ${window.location.href}\nTime: ${new Date().toISOString()}`;
                    showFeedbackModal();
                }
            }

            // Ï†ÑÏó≠ ÏóêÎü¨ Ìï∏Îì§Îü¨Ïóê Ïó∞Í≤∞
            window.showErrorFeedbackPrompt = showErrorFeedbackPrompt;
        </script>

        <!-- Error Handler -->
        <script>
            // Ïñ¥ÎìúÎØº ÌôïÏù∏ Ìï®Ïàò
            function isAdminUser() {
                if (window.getCurrentUser) {
                    return window.getCurrentUser().then(user => {
                        return user && user.email === 'ace060408@gmail.com';
                    }).catch(() => false);
                }
                return Promise.resolve(false);
            }

            window.onerror = function (msg, url, lineNo, columnNo, error) {
                var fileName = url ? url.substring(url.lastIndexOf('/') + 1) : 'Unknown';
                var detailedMessage = "Ïò§Î•ò [" + fileName + ":" + lineNo + "] " + msg;
                var simpleMessage = "ÏùºÏãúÏ†ÅÏù∏ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.";

                console.error(detailedMessage, error);

                // Ïñ¥ÎìúÎØºÏóêÍ≤åÎßå ÏÉÅÏÑ∏ Ïò§Î•ò ÌëúÏãú, ÏùºÎ∞ò ÏÇ¨Ïö©ÏûêÏóêÍ≤åÎäî ÌîºÎìúÎ∞± Ï†úÏïà
                isAdminUser().then(function (isAdmin) {
                    if (isAdmin) {
                        if (window.sim && typeof window.sim.showToast === 'function') {
                            window.sim.showToast(detailedMessage, 'error');
                        }
                    } else {
                        // ÏùºÎ∞ò ÏÇ¨Ïö©ÏûêÏóêÍ≤å ÌîºÎìúÎ∞± Î≥¥ÎÇ¥Í∏∞ Ï†úÏïà (Ïã¨Í∞ÅÌïú Ïò§Î•òÎßå)
                        if (error && window.showErrorFeedbackPrompt) {
                            window.showErrorFeedbackPrompt(msg, error?.stack);
                        }
                    }
                });
                return true; // Ïò§Î•ò Ï†ÑÌåå Ï§ëÎã®
            };

            window.onunhandledrejection = function (event) {
                var msg = event.reason ? event.reason.message : 'Unknown Error';
                console.error("Unhandled Rejection:", event.reason);

                // Ïñ¥ÎìúÎØºÏóêÍ≤åÎßå ÌëúÏãú, ÏùºÎ∞ò ÏÇ¨Ïö©ÏûêÏóêÍ≤åÎäî ÌîºÎìúÎ∞± Ï†úÏïà
                isAdminUser().then(function (isAdmin) {
                    if (isAdmin && window.sim && window.sim.showToast) {
                        window.sim.showToast("ÎπÑÎèôÍ∏∞ Ïò§Î•ò: " + msg, 'error');
                    } else if (window.showErrorFeedbackPrompt) {
                        // ÏùºÎ∞ò ÏÇ¨Ïö©ÏûêÏóêÍ≤å ÌîºÎìúÎ∞± Ï†úÏïà
                        window.showErrorFeedbackPrompt(msg, event.reason?.stack);
                    }
                });
            };
        </script>

        <script src="js/modules/Constants.js"></script>
        <script src="js/modules/CircuitSimulator.js"></script>
        <script src="js/modules/PerformanceOptimizer.js"></script>
        <script src="js/modules/InputHandler.js?v=2.0"></script>
        <script src="js/modules/ProjectIO.js?v=20"></script>
        <script src="js/modules/ComponentManager.js"></script>
        <script src="js/modules/WireManager.js"></script>
        <script src="js/modules/SelectionManager.js"></script>
        <script src="js/modules/LogicEngine.js"></script>
        <script src="js/modules/PackageManager.js"></script>
        <script src="js/modules/TabManager.js"></script>
        <script src="js/modules/UIManager.js"></script>
        <script src="js/modules/HistoryManager.js"></script>
        <script src="js/modules/Oscilloscope.js"></script>
        <script src="js/modules/TutorialSystem.js"></script>
        <script src="js/modules/TouchHandler.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
        <script src="js/modules/SupabaseClient.js"></script>
        <script src="js/modules/LibraryManager.js"></script>
        <script src="js/modules/CircuitValidator.js"></script>
        <script src="js/modules/CollaborationManager.js"></script>
        <script src="js/modules/Main.js?v=2.0"></script>

        <!-- LibraryManager Ï¥àÍ∏∞Ìôî -->
        <script>
            document.addEventListener('DOMContentLoaded', () => {
                if (window.LibraryManager) {
                    window.library = new LibraryManager();
                    console.log('LibraryManager initialized');
                }
            });
        </script>

        <!-- ÏùΩÍ∏∞ Ï†ÑÏö© Î™®Îìú Ï≤òÎ¶¨ -->
        <script>
            // URL ÌååÎùºÎØ∏ÌÑ∞ ÌôïÏù∏
            const urlParams = new URLSearchParams(window.location.search);
            const isReadOnly = urlParams.get('readonly') === 'true' || urlParams.get('view') === 'true';

            // Ï†ÑÏó≠ ÏùΩÍ∏∞ Ï†ÑÏö© ÌîåÎûòÍ∑∏ ÏÑ§Ï†ï (Îã§Î•∏ Î™®ÎìàÏóêÏÑú Ï≤¥ÌÅ¨ Í∞ÄÎä•ÌïòÎèÑÎ°ù)
            window.isReadOnlyMode = isReadOnly;

            if (isReadOnly) {
                console.log('üîí Read-only mode active');

                // [ÌïµÏã¨] bodyÏóê ÌÅ¥ÎûòÏä§Î•º Ï∂îÍ∞ÄÌïòÏó¨ CSSÎ°ú Í∞ïÏ†ú Ï†úÏñ¥ (Î°úÍ∑∏Ïù∏ Î°úÏßÅÏù¥ ÎçÆÏñ¥Ïì∞ÏßÄ Î™ªÌïòÎèÑÎ°ù)
                document.body.classList.add('readonly-mode');

                // 1. CSSÎ°ú UI Í∞ïÏ†ú Ïà®ÍπÄ (Í∞ÄÏû• Í∞ïÎ†•Ìïú Î∞©Ïñ¥)
                const style = document.createElement('style');
                style.textContent = `
                /* ÏùΩÍ∏∞ Î™®ÎìúÏùº Îïå Î¨¥Ï°∞Í±¥ Ïà®Í≤®Ïïº Ìï† ÏöîÏÜåÎì§ */
                body.readonly-mode .toolbar-group,
                body.readonly-mode .icon-btn:not(.home-btn),
                body.readonly-mode .toolbar-divider,
                body.readonly-mode .btn-collaborate,
                body.readonly-mode .left-sidebar,
                body.readonly-mode .component-panel,
                body.readonly-mode #sidebar,
                body.readonly-mode .sidebar-toggle-btn,
                body.readonly-mode #section-modules,
                body.readonly-mode #section-transistors,
                body.readonly-mode .feedback-btn {
                    display: none !important;
                }

                /* Î†àÏù¥ÏïÑÏõÉ Í∞ïÏ†ú Ï°∞Ï†ï */
                body.readonly-mode .workspace-wrapper,
                body.readonly-mode .canvas-container,
                body.readonly-mode #app-container {
                    margin-left: 0 !important;
                    left: 0 !important;
                    width: 100vw !important;
                    max-width: 100vw !important;
                }
                
                /* Ìôà Î≤ÑÌäº(Log out Îì±)ÏùÄ Î≥¥Ïù¥Í≤å - .home-btn ÌÅ¥ÎûòÏä§Í∞Ä ÏóÜÏúºÎ©¥ onclick ÏÜçÏÑ±ÏúºÎ°ú Ï∞æÏùå */
                body.readonly-mode .icon-btn[onclick*="goHome"] {
                    display: flex !important;
                    z-index: 2000;
                }
            `;
                document.head.appendChild(style);

                // 2. DOMContentLoaded ÎåÄÍ∏∞ ÌõÑ Î∞∞ÎÑà Ï∂îÍ∞Ä (ÏïàÏ†ÑÌïòÍ≤å)
                document.addEventListener('DOMContentLoaded', () => {
                    // Í∏∞Ï°¥ JS Ïà®ÍπÄ Î°úÏßÅ (ÌòπÏãú Î™®Î•º ÎåÄÎπÑ)
                    const toolbars = document.querySelectorAll('.toolbar-group, .icon-btn, .toolbar-divider, .btn-collaborate');
                    toolbars.forEach(el => {
                        const onClick = el.getAttribute('onclick');
                        if (!onClick || !onClick.includes('goHome')) {
                            el.style.display = 'none';
                        }
                    });

                    const sidebars = document.querySelectorAll('.left-sidebar, .component-panel, #sidebar');
                    sidebars.forEach(el => el.style.display = 'none');

                    // ÏùΩÍ∏∞ Ï†ÑÏö© Î∞∞ÎÑà ÌëúÏãú
                    const banner = document.createElement('div');
                    banner.id = 'readonly-banner';
                    banner.style.cssText = `
                    width: 100%;
                    height: 40px;
                    background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 14px;
                    font-weight: 600;
                    z-index: 900;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                    font-family: 'Inter', sans-serif;
                    flex-shrink: 0;
                `;
                    banner.innerHTML = '<span>üëÄ <b>ÏùΩÍ∏∞ Ï†ÑÏö© Î™®Îìú</b> - ÌöåÎ°úÎ•º ÏàòÏ†ïÌï† Ïàò ÏóÜÏäµÎãàÎã§. ÌÅ¥Î¶≠ÌïòÏó¨ Î™®Îìà ÎÇ¥Î∂ÄÎ•º ÌôïÏù∏ÌïòÍ±∞ÎÇò ÏûêÏú†Î°≠Í≤å ÌôïÎåÄ/Ï∂ïÏÜåÌïòÏÑ∏Ïöî.</span>';

                    const wrapper = document.querySelector('.workspace-wrapper');
                    if (wrapper) {
                        wrapper.insertBefore(banner, wrapper.firstChild);
                    } else {
                        banner.style.position = 'fixed';
                        banner.style.top = '50px'; // Ìó§Îçî ÎÜíÏù¥Ïóê ÎßûÏ∂§
                        document.body.appendChild(banner);
                    }

                    // Ï∫îÎ≤ÑÏä§ Ìé∏Ïßë Ï∞®Îã®
                    const canvas = document.querySelector('canvas');
                    if (canvas) {
                        canvas.style.cursor = 'default';

                        // ÌÇ§Î≥¥Îìú Ï∞®Îã® (Îã®, ÏûÖÎ†• ÌïÑÎìúÏóêÏÑúÎäî ÌóàÏö©)
                        document.addEventListener('keydown', (e) => {
                            // ÏûÖÎ†• ÌïÑÎìúÏóê Ìè¨Ïª§Ïä§ ÏûàÏúºÎ©¥ ÌÇ§ ÏûÖÎ†• ÌóàÏö©
                            const activeTag = document.activeElement?.tagName?.toUpperCase();
                            if (activeTag === 'INPUT' || activeTag === 'TEXTAREA') {
                                return; // ÎåìÍ∏Ä ÏûÖÎ†• Îì± ÌóàÏö©
                            }

                            const key = e.key.toUpperCase();
                            const isCtrl = e.ctrlKey || e.metaKey;

                            // [PASS] ÏãúÏä§ÌÖú ÌÇ§(F1~F12) Î∞è ÏÉàÎ°úÍ≥†Ïπ®(Ctrl+R) ÌÜµÍ≥º
                            if (key.startsWith('F') || (isCtrl && key === 'R')) {
                                return;
                            }

                            if (key === 'DELETE' || key === 'BACKSPACE') {
                                e.preventDefault();
                                e.stopPropagation();
                                return;
                            }

                            if (isCtrl && ['C', 'V', 'X', 'Z', 'Y', 'S'].includes(key)) {
                                e.preventDefault();
                                e.stopPropagation();
                                return;
                            }
                        }, true);
                    }

                    // === ÎåìÍ∏Ä Ìå®ÎÑê Ï∂îÍ∞Ä (ÏùΩÍ∏∞ Ï†ÑÏö© Î™®ÎìúÏóêÏÑúÎßå) ===
                    createCommentPanel();
                });
            }

            // ÎåìÍ∏Ä Ìå®ÎÑê ÏÉùÏÑ± Ìï®Ïàò
            function createCommentPanel() {
                // FAB Î≤ÑÌäº (ÎåìÍ∏Ä Ïó¥Í∏∞)
                const fab = document.createElement('button');
                fab.id = 'comment-fab';
                fab.innerHTML = 'üí¨';
                fab.title = 'ÎåìÍ∏Ä Î≥¥Í∏∞';
                fab.style.cssText = `
                position: fixed;
                bottom: 24px;
                right: 24px;
                width: 56px;
                height: 56px;
                border-radius: 50%;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border: none;
                font-size: 24px;
                cursor: pointer;
                box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
                z-index: 99999;
                transition: transform 0.2s, box-shadow 0.2s;
                pointer-events: auto;
            `;
                fab.onmouseenter = () => fab.style.transform = 'scale(1.1)';
                fab.onmouseleave = () => fab.style.transform = 'scale(1)';
                fab.onclick = toggleCommentPanel;
                document.body.appendChild(fab);

                // ÎåìÍ∏Ä Ìå®ÎÑê
                const panel = document.createElement('div');
                panel.id = 'comment-panel';
                panel.style.cssText = `
                position: fixed;
                bottom: 0;
                right: 0;
                width: 360px;
                max-width: 100%;
                height: 60vh;
                background: #0d0d12;
                border-top-left-radius: 16px;
                border-left: 1px solid rgba(255,255,255,0.1);
                border-top: 1px solid rgba(255,255,255,0.1);
                z-index: 100000;
                transform: translateX(100%);
                transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
                display: flex;
                flex-direction: column;
                font-family: 'Inter', sans-serif;
                pointer-events: auto;
            `;
                panel.innerHTML = `
                <div style="padding: 16px 20px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="margin: 0; font-size: 16px; font-weight: 600; color: #fff;">üí¨ ÎåìÍ∏Ä & Î∞òÏùë</h3>
                    <button onclick="toggleCommentPanel()" style="background: none; border: none; color: #888; font-size: 20px; cursor: pointer;">√ó</button>
                </div>
                <div style="padding: 12px 20px; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; gap: 16px; align-items: center;">
                    <button id="sim-like-btn" onclick="toggleSimLike()" 
                        style="padding: 8px 16px; background: #1a1a24; border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; color: #fff; font-size: 13px; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: all 0.2s;">
                        <span id="sim-like-icon">ü§ç</span> <span id="sim-like-count">0</span>
                    </button>
                    <span style="color: #666; font-size: 12px;">üëÅ <span id="sim-view-count">0</span> Ï°∞Ìöå</span>
                </div>
                <div id="sim-comments-list" style="flex: 1; overflow-y: auto; padding: 16px;">
                    <div style="color: #666; text-align: center; padding: 40px 20px;">ÎåìÍ∏ÄÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë...</div>
                </div>
                <div style="padding: 12px 16px; border-top: 1px solid rgba(255,255,255,0.1); display: flex; gap: 8px;">
                    <input type="text" id="sim-comment-input" placeholder="ÎåìÍ∏ÄÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî..." 
                        style="flex: 1; padding: 10px 12px; background: #1a1a24; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff; font-size: 13px;">
                    <button onclick="submitSimComment()" 
                        style="padding: 10px 16px; background: #667eea; color: white; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer;">
                        ÏûëÏÑ±
                    </button>
                </div>
            `;
                document.body.appendChild(panel);

                // Ìå®ÎÑê Ïó¥Î¶¥ Îïå ÎåìÍ∏Ä Î°úÎìú + ÌÜµÍ≥Ñ Î°úÎìú
                loadSimComments();
                loadSimStats();
            }

            let isCommentPanelOpen = false;
            function toggleCommentPanel() {
                const panel = document.getElementById('comment-panel');
                const fab = document.getElementById('comment-fab');
                isCommentPanelOpen = !isCommentPanelOpen;

                if (isCommentPanelOpen) {
                    panel.style.transform = 'translateX(0)';
                    fab.innerHTML = '‚úï';
                    fab.style.background = '#333';
                    loadSimComments();
                } else {
                    panel.style.transform = 'translateX(100%)';
                    fab.innerHTML = 'üí¨';
                    fab.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                }
            }

            async function loadSimComments() {
                const list = document.getElementById('sim-comments-list');
                if (!list || !window.sb) return;

                const projectId = new URLSearchParams(window.location.search).get('id');
                if (!projectId) {
                    list.innerHTML = '<div style="color: #666; text-align: center; padding: 40px;">ÌîÑÎ°úÏ†ùÌä∏ IDÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.</div>';
                    return;
                }

                try {
                    const { data: comments, error } = await window.sb
                        .from('project_comments')
                        .select('*')
                        .eq('project_id', projectId)
                        .order('created_at', { ascending: false });

                    if (error) throw error;

                    if (!comments || comments.length === 0) {
                        list.innerHTML = '<div style="color: #666; text-align: center; padding: 40px;">ÏïÑÏßÅ ÎåìÍ∏ÄÏù¥ ÏóÜÏäµÎãàÎã§.<br>Ï≤´ ÎåìÍ∏ÄÏùÑ ÎÇ®Í≤®Î≥¥ÏÑ∏Ïöî!</div>';
                        return;
                    }

                    list.innerHTML = comments.map(c => {
                        const date = new Date(c.created_at).toLocaleString();
                        return `
                        <div style="padding: 12px; background: #1a1a24; border-radius: 8px; margin-bottom: 10px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                                <span style="font-size: 12px; font-weight: 500; color: #fff;">${c.user_name || 'ÏùµÎ™Ö'}</span>
                                <span style="font-size: 11px; color: #666;">${date}</span>
                            </div>
                            <div style="font-size: 13px; color: #aaa; line-height: 1.5;">${c.content}</div>
                        </div>
                    `;
                    }).join('');
                } catch (e) {
                    console.error('Failed to load comments:', e);
                    list.innerHTML = '<div style="color: #f66; text-align: center; padding: 40px;">ÎåìÍ∏ÄÏùÑ Î∂àÎü¨Ïò§ÏßÄ Î™ªÌñàÏäµÎãàÎã§.</div>';
                }
            }

            async function submitSimComment() {
                const input = document.getElementById('sim-comment-input');
                const content = input?.value?.trim();
                if (!content) return;

                const projectId = new URLSearchParams(window.location.search).get('id');
                if (!projectId || !window.sb) return;

                try {
                    const { data: { user } } = await window.sb.auth.getUser();
                    if (!user) {
                        alert('ÎåìÍ∏ÄÏùÑ ÏûëÏÑ±ÌïòÎ†§Î©¥ Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.');
                        return;
                    }

                    const userName = user.user_metadata?.full_name || user.email?.split('@')[0] || 'ÏùµÎ™Ö';

                    const { error } = await window.sb
                        .from('project_comments')
                        .insert({
                            project_id: projectId,
                            user_id: user.id,
                            user_email: user.email,
                            user_name: userName,
                            content: content
                        });
                    if (error) throw error;

                    input.value = '';
                    await loadSimComments();
                } catch (e) {
                    console.error('Failed to submit comment:', e);
                    alert('ÎåìÍ∏Ä ÏûëÏÑ± Ïã§Ìå®: ' + e.message);
                }
            }

            // ÌîÑÎ°úÏ†ùÌä∏ ÌÜµÍ≥Ñ Î°úÎìú (Ï¢ãÏïÑÏöî, Ï°∞ÌöåÏàò)
            let simProjectLiked = false;
            async function loadSimStats() {
                const projectId = new URLSearchParams(window.location.search).get('id');
                if (!projectId || !window.sb) return;

                try {
                    // ÌîÑÎ°úÏ†ùÌä∏ Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
                    const { data: project } = await window.sb
                        .from('projects')
                        .select('likes, views')
                        .eq('id', projectId)
                        .single();

                    if (project) {
                        document.getElementById('sim-like-count').textContent = project.likes || 0;
                        document.getElementById('sim-view-count').textContent = project.views || 0;
                    }

                    // ÎÇ¥Í∞Ä Ï¢ãÏïÑÏöî ÌñàÎäîÏßÄ ÌôïÏù∏
                    const { data: { user } } = await window.sb.auth.getUser();
                    if (user) {
                        const { data: like } = await window.sb
                            .from('project_likes')
                            .select('id')
                            .eq('project_id', projectId)
                            .eq('user_id', user.id)
                            .single();

                        simProjectLiked = !!like;
                        updateLikeButton();
                    }
                } catch (e) {
                    console.warn('Failed to load stats:', e);
                }
            }

            function updateLikeButton() {
                const btn = document.getElementById('sim-like-btn');
                const icon = document.getElementById('sim-like-icon');
                if (simProjectLiked) {
                    btn.style.background = 'rgba(239, 68, 68, 0.2)';
                    btn.style.borderColor = '#ef4444';
                    icon.textContent = '‚ù§Ô∏è';
                } else {
                    btn.style.background = '#1a1a24';
                    btn.style.borderColor = 'rgba(255,255,255,0.1)';
                    icon.textContent = 'ü§ç';
                }
            }

            async function toggleSimLike() {
                const projectId = new URLSearchParams(window.location.search).get('id');
                if (!projectId || !window.sb) return;

                try {
                    const { data: { user } } = await window.sb.auth.getUser();
                    if (!user) {
                        alert('Ï¢ãÏïÑÏöîÎ•º ÎàÑÎ•¥Î†§Î©¥ Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.');
                        return;
                    }

                    const countEl = document.getElementById('sim-like-count');
                    let count = parseInt(countEl.textContent) || 0;

                    if (simProjectLiked) {
                        // Ï¢ãÏïÑÏöî Ï∑®ÏÜå
                        await window.sb
                            .from('project_likes')
                            .delete()
                            .eq('project_id', projectId)
                            .eq('user_id', user.id);

                        simProjectLiked = false;
                        count = Math.max(0, count - 1);
                    } else {
                        // Ï¢ãÏïÑÏöî Ï∂îÍ∞Ä
                        await window.sb
                            .from('project_likes')
                            .insert({
                                project_id: projectId,
                                user_id: user.id
                            });

                        simProjectLiked = true;
                        count++;
                    }

                    countEl.textContent = count;
                    updateLikeButton();

                    // DBÏóêÎèÑ likes Ïπ¥Ïö¥Ìä∏ ÎèôÍ∏∞Ìôî (Ìä∏Î¶¨Í±∞Í∞Ä ÏóÜÎã§Î©¥ ÏàòÎèô)
                    await window.sb
                        .from('projects')
                        .update({ likes: count })
                        .eq('id', projectId);

                } catch (e) {
                    console.error('Failed to toggle like:', e);
                    alert('Ï¢ãÏïÑÏöî Ïã§Ìå®: ' + e.message);
                }
            }
        </script>

        <script>
            async function goHome() {
                if (window.getCurrentUser) {
                    const user = await window.getCurrentUser();
                    if (user) {
                        location.href = 'dashboard.html';
                        return;
                    }
                }
                location.href = 'index.html';
            }
        </script>

        <!-- ======== Validation Panel ======== -->
        <div id="validation-panel" class="validation-panel">
            <div class="validation-header">
                <h2>ÌöåÎ°ú Í≤ÄÏ¶ù</h2>
                <button class="validation-close" onclick="sim.validator?.togglePanel()">√ó</button>
            </div>

            <div class="validation-actions">
                <button class="validate-btn" onclick="sim.validator?.validateCircuit()">
                    Í≤ÄÏ¶ù ÏãúÏûë
                </button>
                <button class="auto-validate-toggle" id="auto-validate-toggle"
                    onclick="sim.validator && toggleAutoValidate()">
                    ÏûêÎèô
                </button>
            </div>

            <div class="validation-stats" id="validation-stats" style="display: none;">
                <div class="stat-item errors">
                    <span class="stat-value" id="stat-errors">0</span>
                    <span class="stat-label">Ïò§Î•ò</span>
                </div>
                <div class="stat-item warnings">
                    <span class="stat-value" id="stat-warnings">0</span>
                    <span class="stat-label">Í≤ΩÍ≥†</span>
                </div>
                <div class="stat-item suggestions">
                    <span class="stat-value" id="stat-suggestions">0</span>
                    <span class="stat-label">Ï†úÏïà</span>
                </div>
            </div>

            <div class="validation-content">
                <div class="validation-empty">
                    <div class="validation-empty-icon">üîç</div>
                    <div class="validation-empty-text">
                        'Í≤ÄÏ¶ù ÏãúÏûë' Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ÌïòÏó¨<br>
                        ÌöåÎ°ú Ïò§Î•òÎ•º Í≤ÄÏÇ¨ÌïòÏÑ∏Ïöî.
                    </div>
                </div>
            </div>
        </div>

        <script>
            // ÏûêÎèô Í≤ÄÏ¶ù ÌÜ†Í∏Ä
            function toggleAutoValidate() {
                const toggle = document.getElementById('auto-validate-toggle');
                const isActive = toggle.classList.toggle('active');

                if (isActive) {
                    // ÏûêÎèô Í≤ÄÏ¶ù ÌôúÏÑ±Ìôî: Î≥ÄÍ≤ΩÏÇ¨Ìï≠ Í∞êÏßÄ Ïãú Í≤ÄÏ¶ù
                    if (window.sim && window.sim.validator) {
                        window.autoValidateEnabled = true;
                    }
                } else {
                    window.autoValidateEnabled = false;
                }
            }

            // ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
            function updateValidationStats(results) {
                const statsEl = document.getElementById('validation-stats');
                if (!statsEl) return;

                const errors = results.errors?.length || 0;
                const warnings = results.warnings?.length || 0;
                const suggestions = results.suggestions?.length || 0;

                document.getElementById('stat-errors').textContent = errors;
                document.getElementById('stat-warnings').textContent = warnings;
                document.getElementById('stat-suggestions').textContent = suggestions;

                if (errors + warnings + suggestions > 0) {
                    statsEl.style.display = 'flex';
                } else {
                    statsEl.style.display = 'none';
                }
            }
        </script>

        <!-- ======== Collaboration Panel ======== -->
        <div id="collaboration-panel" class="collaboration-panel hidden">
            <div class="collab-header">
                <span>Ïã§ÏãúÍ∞Ñ ÌòëÏóÖ</span>
                <button class="collab-toggle" onclick="toggleCollaborationPanel()">√ó</button>
            </div>

            <div id="collaborators-list" class="no-collaborators">
                ÌòëÏóÖ ÏãúÏûë Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ÌïòÏÑ∏Ïöî
            </div>

            <div style="padding: 12px;">
                <button class="btn-invite-collab" onclick="showInviteModal()"
                    style="width: 100%; padding: 10px; background: var(--accent-blue, #3b82f6); color: white; border: none; border-radius: 6px; font-weight: 600; font-size: 13px; cursor: pointer; margin-bottom: 8px;">
                    üë• ÌòëÏóÖÏûê Ï¥àÎåÄ
                </button>
                <div id="collab-status"
                    style="font-size: 11px; color: var(--text-tertiary); text-align: center; margin-bottom: 8px;">
                    Ïò§ÌîÑÎùºÏù∏
                </div>
            </div>
        </div>

        <!-- Invite Modal -->
        <div id="invite-modal" class="invite-modal" style="display: none;">
            <div class="invite-content">
                <h3>ÌòëÏóÖÏûê Ï¥àÎåÄ</h3>
                <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 16px;">
                    Ïù¥Î©îÏùºÎ°ú ÌòëÏóÖÏûêÎ•º Ï¥àÎåÄÌïòÏÑ∏Ïöî
                </p>

                <input type="email" id="invite-email" class="invite-input" placeholder="user@example.com">

                <div style="margin-bottom: 16px;">
                    <label
                        style="display: block; font-size: 12px; margin-bottom: 8px; color: var(--text-secondary);">Í∂åÌïú</label>
                    <select id="invite-role"
                        style="width: 100%; padding: 10px; background: var(--bg-default, #0a0a0a); border: 1px solid var(--border-default, #333); border-radius: 6px; color: var(--text-primary, #fff);">
                        <option value="editor">Ìé∏ÏßëÏûê - ÌöåÎ°ú ÏàòÏ†ï Í∞ÄÎä•</option>
                        <option value="viewer">Î∑∞Ïñ¥ - ÏùΩÍ∏∞Îßå Í∞ÄÎä•</option>
                    </select>
                </div>

                <div id="invite-error" style="color: #ef4444; font-size: 12px; margin-bottom: 12px; display: none;">
                </div>

                <div class="invite-actions">
                    <button class="btn-invite-cancel" onclick="closeInviteModal()">Ï∑®ÏÜå</button>
                    <button class="btn-invite-send" onclick="sendInvite()">Ï¥àÎåÄ Î≥¥ÎÇ¥Í∏∞</button>
                </div>
            </div>
        </div>

        <!-- Collaboration Status Indicator -->
        <div id="collaboration-status" class="collaboration-status" style="display: none;">
            <span id="status-icon">‚óè</span>
            <span id="status-text">ÌòëÏóÖ Ï§ë...</span>
        </div>

        <script>
            // ÌòëÏóÖ ÌÜ†Í∏Ä
            async function toggleCollaboration() {
                if (!window.sim || !window.sim.collaboration) {
                    alert('ÌòëÏóÖ Í∏∞Îä•ÏùÑ Ï¥àÍ∏∞ÌôîÌïòÎäî Ï§ëÏûÖÎãàÎã§. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌïòÏÑ∏Ïöî.');
                    return;
                }

                const btn = document.getElementById('btn-collaborate');
                const panel = document.getElementById('collaboration-panel');
                const status = document.getElementById('collaboration-status');
                const statusText = document.getElementById('collab-status');

                if (window.sim.collaboration.isConnected) {
                    // ÌòëÏóÖ Ï¢ÖÎ£å
                    await window.sim.collaboration.stopCollaboration();
                    btn.classList.remove('active');
                    btn.style.background = '';
                    status.style.display = 'none';
                    statusText.textContent = 'Ïò§ÌîÑÎùºÏù∏';
                    statusText.style.color = 'var(--text-tertiary)';

                    if (window.sim.showToast) {
                        window.sim.showToast('ÌòëÏóÖÏù¥ Ï¢ÖÎ£åÎêòÏóàÏäµÎãàÎã§', 'info');
                    }
                } else {
                    // ÌòëÏóÖ ÏãúÏûë
                    if (!window.sim.currentProjectId) {
                        alert('ÌîÑÎ°úÏ†ùÌä∏Î•º Î®ºÏ†Ä Ï†ÄÏû•Ìï¥Ï£ºÏÑ∏Ïöî.');
                        return;
                    }

                    try {
                        await window.sim.collaboration.startCollaboration(window.sim.currentProjectId);
                        btn.classList.add('active');
                        btn.style.background = 'var(--accent-green, #22c55e)';
                        status.style.display = 'flex';
                        status.classList.add('connected');
                        statusText.textContent = 'Ïò®ÎùºÏù∏';
                        statusText.style.color = 'var(--accent-green)';

                        // Ìå®ÎÑê ÌëúÏãú
                        panel.classList.remove('hidden');
                    } catch (error) {
                        console.error('Failed to start collaboration:', error);
                        alert('ÌòëÏóÖÏùÑ ÏãúÏûëÌï† Ïàò ÏóÜÏäµÎãàÎã§: ' + error.message);
                    }
                }
            }

            // ÌòëÏóÖ Ìå®ÎÑê ÌÜ†Í∏Ä
            function toggleCollaborationPanel() {
                const panel = document.getElementById('collaboration-panel');
                panel.classList.toggle('hidden');
            }

            // Ï¥àÎåÄ Î™®Îã¨ Ïó¥Í∏∞
            function showInviteModal() {
                if (!window.sim || !window.sim.currentProjectId) {
                    alert('ÌîÑÎ°úÏ†ùÌä∏Î•º Î®ºÏ†Ä Ï†ÄÏû•Ìï¥Ï£ºÏÑ∏Ïöî.');
                    return;
                }
                document.getElementById('invite-modal').style.display = 'flex';
                document.getElementById('invite-email').focus();
            }

            // Ï¥àÎåÄ Î™®Îã¨ Îã´Í∏∞
            function closeInviteModal() {
                document.getElementById('invite-modal').style.display = 'none';
                document.getElementById('invite-email').value = '';
                document.getElementById('invite-role').value = 'editor';
                document.getElementById('invite-error').style.display = 'none';
            }

            // Ï¥àÎåÄ Î≥¥ÎÇ¥Í∏∞
            async function sendInvite() {
                const emailInput = document.getElementById('invite-email');
                const roleSelect = document.getElementById('invite-role');
                const errorDiv = document.getElementById('invite-error');

                const email = emailInput.value.trim();
                const role = roleSelect.value;

                // Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨
                if (!email) {
                    errorDiv.textContent = 'Ïù¥Î©îÏùºÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.';
                    errorDiv.style.display = 'block';
                    return;
                }

                if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                    errorDiv.textContent = 'Ïò¨Î∞îÎ•∏ Ïù¥Î©îÏùº ÌòïÏãùÏù¥ ÏïÑÎãôÎãàÎã§.';
                    errorDiv.style.display = 'block';
                    return;
                }

                errorDiv.style.display = 'none';

                try {
                    if (!window.sim.collaboration) {
                        throw new Error('ÌòëÏóÖ Í∏∞Îä•Ïù¥ Ï¥àÍ∏∞ÌôîÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.');
                    }

                    await window.sim.collaboration.inviteCollaborator(
                        window.sim.currentProjectId,
                        email,
                        role
                    );

                    if (window.sim.showToast) {
                        window.sim.showToast('‚úì Ï¥àÎåÄÎ•º Î≥¥ÎÉàÏäµÎãàÎã§!', 'success');
                    }

                    closeInviteModal();
                } catch (error) {
                    console.error('Invite error:', error);
                    errorDiv.textContent = error.message || 'Ï¥àÎåÄ Ïã§Ìå®';
                    errorDiv.style.display = 'block';
                }
            }
        </script>

        <!-- Publish Settings Modal -->
        <div id="publish-modal" class="modal-overlay" style="display: none; z-index: 3000;">
            <div class="modal-window"
                style="width: 500px; background: var(--bg-surface); border: 1px solid var(--border-default); box-shadow: 0 20px 50px rgba(0,0,0,0.5); padding: 32px; border-radius: 12px;">
                <h2 style="margin: 0 0 24px 0; font-size: 20px; font-weight: 600; color: var(--text-primary);">ÌîÑÎ°úÏ†ùÌä∏ Í≥µÍ∞ú
                    ÏÑ§Ï†ï
                </h2>

                <div style="margin-bottom: 20px;">
                    <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                        <input type="checkbox" id="is-public-checkbox"
                            style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="font-size: 15px; color: var(--text-primary);">Ïª§ÎÆ§ÎãàÌã∞Ïóê Í≥µÍ∞ú</span>
                    </label>
                    <small
                        style="display: block; margin-top: 6px; margin-left: 30px; color: var(--text-secondary); font-size: 12px;">
                        Í≥µÍ∞úÌïòÎ©¥ ÎùºÏù¥Î∏åÎü¨Î¶¨ ÌéòÏù¥ÏßÄÏóê ÌëúÏãúÎê©ÎãàÎã§
                    </small>
                </div>

                <div style="margin-bottom: 20px;">
                    <label
                        style="display: block; margin-bottom: 8px; font-size: 13px; font-weight: 500; color: var(--text-primary);">
                        ÌîÑÎ°úÏ†ùÌä∏ ÏÑ§Î™Ö
                    </label>
                    <textarea id="project-description-input" placeholder="Ïù¥ ÌöåÎ°úÍ∞Ä Î¨¥ÏóáÏùÑ ÌïòÎäîÏßÄ ÏÑ§Î™ÖÌïòÏÑ∏Ïöî..."
                        style="width: 100%; padding: 12px; background: var(--bg-default); border: 1px solid var(--border-default); border-radius: 6px; color: var(--text-primary); font-family: inherit; font-size: 14px; resize: vertical; min-height: 80px;"></textarea>
                </div>

                <div style="margin-bottom: 24px;">
                    <label
                        style="display: block; margin-bottom: 8px; font-size: 13px; font-weight: 500; color: var(--text-primary);">
                        ÌÉúÍ∑∏ (ÏâºÌëúÎ°ú Íµ¨Î∂Ñ)
                    </label>
                    <input type="text" id="project-tags-input" placeholder="Ïòà: logic, gates, adder"
                        style="width: 100%; padding: 10px 12px; background: var(--bg-default); border: 1px solid var(--border-default); border-radius: 6px; color: var(--text-primary); font-size: 14px;">
                    <small style="display: block; margin-top: 6px; color: var(--text-secondary); font-size: 12px;">
                        Í≤ÄÏÉâÍ≥º ÌïÑÌÑ∞ÎßÅÏóê ÏÇ¨Ïö©Îê©ÎãàÎã§
                    </small>
                </div>

                <div id="publish-error" style="color: #ef4444; font-size: 13px; margin-bottom: 16px; display: none;">
                </div>

                <div style="display: flex; gap: 12px;">
                    <button onclick="closePublishModal()"
                        style="flex: 1; padding: 12px; background: var(--bg-hover); border: 1px solid var(--border-default); border-radius: 6px; color: var(--text-secondary); cursor: pointer; font-size: 14px; font-weight: 500;">
                        Ï∑®ÏÜå
                    </button>
                    <button onclick="savePublishSettings()"
                        style="flex: 1; padding: 12px; background: var(--accent-blue, #3b82f6); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">
                        Ï†ÄÏû•
                    </button>
                </div>
            </div>
        </div>

        <script>
            // Í≥µÍ∞ú ÏÑ§Ï†ï Î™®Îã¨ Ïó¥Í∏∞
            async function showPublishModal() {
                if (!window.sim || !window.sim.currentProjectId) {
                    alert('ÌîÑÎ°úÏ†ùÌä∏Î•º Î®ºÏ†Ä Ï†ÄÏû•Ìï¥Ï£ºÏÑ∏Ïöî.');
                    return;
                }

                // ÌòÑÏû¨ ÌîÑÎ°úÏ†ùÌä∏ Ï†ïÎ≥¥ Î∂àÎü¨Ïò§Í∏∞
                try {
                    const { data: project } = await window.sb
                        .from('projects')
                        .select('is_public, description, tags')
                        .eq('id', window.sim.currentProjectId)
                        .single();

                    if (project) {
                        document.getElementById('is-public-checkbox').checked = project.is_public || false;
                        document.getElementById('project-description-input').value = project.description || '';
                        document.getElementById('project-tags-input').value = project.tags ? project.tags.join(', ') : '';
                    }
                } catch (error) {
                    console.error('Failed to load project settings:', error);
                }

                document.getElementById('publish-modal').style.display = 'flex';
            }

            // Í≥µÍ∞ú ÏÑ§Ï†ï Î™®Îã¨ Îã´Í∏∞
            function closePublishModal() {
                document.getElementById('publish-modal').style.display = 'none';
                document.getElementById('publish-error').style.display = 'none';
            }

            // Í≥µÍ∞ú ÏÑ§Ï†ï Ï†ÄÏû•
            async function savePublishSettings() {
                const isPublic = document.getElementById('is-public-checkbox').checked;
                const description = document.getElementById('project-description-input').value.trim();
                const tagsStr = document.getElementById('project-tags-input').value.trim();
                const tags = tagsStr ? tagsStr.split(',').map(t => t.trim()).filter(t => t) : [];
                const errorDiv = document.getElementById('publish-error');

                if (!window.sim || !window.sim.currentProjectId) {
                    errorDiv.textContent = 'ÌîÑÎ°úÏ†ùÌä∏ IDÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.';
                    errorDiv.style.display = 'block';
                    return;
                }

                if (!window.library) {
                    errorDiv.textContent = 'LibraryManagerÍ∞Ä Ï¥àÍ∏∞ÌôîÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.';
                    errorDiv.style.display = 'block';
                    return;
                }

                try {
                    if (isPublic) {
                        await window.library.makeProjectPublic(
                            window.sim.currentProjectId,
                            description,
                            tags
                        );
                        if (window.sim.showToast) {
                            window.sim.showToast('‚úì ÌîÑÎ°úÏ†ùÌä∏Í∞Ä Í≥µÍ∞úÎêòÏóàÏäµÎãàÎã§!', 'success');
                        } else {
                            alert('‚úì ÌîÑÎ°úÏ†ùÌä∏Í∞Ä Í≥µÍ∞úÎêòÏóàÏäµÎãàÎã§!');
                        }
                    } else {
                        await window.library.makeProjectPrivate(window.sim.currentProjectId);
                        if (window.sim.showToast) {
                            window.sim.showToast('‚úì ÌîÑÎ°úÏ†ùÌä∏Í∞Ä ÎπÑÍ≥µÍ∞úÎ°ú Ï†ÑÌôòÎêòÏóàÏäµÎãàÎã§', 'info');
                        } else {
                            alert('‚úì ÌîÑÎ°úÏ†ùÌä∏Í∞Ä ÎπÑÍ≥µÍ∞úÎ°ú Ï†ÑÌôòÎêòÏóàÏäµÎãàÎã§');
                        }
                    }
                    closePublishModal();
                } catch (error) {
                    console.error('Publish error:', error);
                    errorDiv.textContent = 'Ïò§Î•ò: ' + (error.message || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò');
                    errorDiv.style.display = 'block';
                }
            }

            // [Ïä§ÎÉÖÏÉ∑ Î°úÎìú] Í≤åÏãúÍ∏ÄÏóêÏÑú Ï≤®Î∂ÄÎêú ÌöåÎ°ú Ïä§ÎÉÖÏÉ∑ ÌôïÏù∏ Î∞è Î°úÎìú
            document.addEventListener('DOMContentLoaded', async () => {
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('snapshot') === 'true') {
                    const snapshotData = localStorage.getItem('temp_circuit_snapshot');
                    if (snapshotData) {
                        console.log('üîç Ïä§ÎÉÖÏÉ∑ Îç∞Ïù¥ÌÑ∞ Í∞êÏßÄÎê®');
                        try {
                            // ÏãúÎÆ¨Î†àÏù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî ÎåÄÍ∏∞ (sim Í∞ùÏ≤¥Í∞Ä ÏÉùÏÑ±Îê† ÎïåÍπåÏßÄ)
                            let attempts = 0;
                            const waitForSim = setInterval(() => {
                                attempts++;
                                if (window.sim && window.sim.loadProject) {
                                    clearInterval(waitForSim);

                                    try {
                                        const data = JSON.parse(snapshotData);

                                        // [Ï§ëÏöî] ÏõêÎ≥∏ ÌîÑÎ°úÏ†ùÌä∏ ÎçÆÏñ¥Ïì∞Í∏∞ Î∞©ÏßÄ: ID Ï†úÍ±∞ÌïòÏó¨ ÏÉà ÌîÑÎ°úÏ†ùÌä∏Î°ú Ï∑®Í∏â
                                        delete data.id;

                                        // Ïä§ÎÉÖÏÉ∑ Ïù¥Î¶ÑÏúºÎ°ú ÌÉÄÏù¥ÌãÄ Î≥ÄÍ≤Ω
                                        if (data.projectName) {
                                            document.querySelector('.project-name').value = data.projectName + ' (Ïä§ÎÉÖÏÉ∑)';
                                        }

                                        window.sim.loadProject(data);
                                        window.sim.showToast('üìë Í≤åÏãúÍ∏Ä ÌöåÎ°ú Ïä§ÎÉÖÏÉ∑ÏùÑ Î∂àÎü¨ÏôîÏäµÎãàÎã§ (ÏùΩÍ∏∞ Ï†ÑÏö©)', 'info');

                                        // ÏùΩÍ∏∞ Ï†ÑÏö© Î™®Îìú Í∞ïÏ†ú Ï†ÅÏö© (ÏÑ†ÌÉù)
                                        window.isReadOnlyMode = true;
                                        document.body.classList.add('readonly-mode');
                                    } catch (parseError) {
                                        console.error('JSON Parse error:', parseError);
                                    }
                                } else if (attempts > 50) { // 5Ï¥à ÌÉÄÏûÑÏïÑÏõÉ
                                    clearInterval(waitForSim);
                                    console.error('ÏãúÎÆ¨Î†àÏù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî ÌÉÄÏûÑÏïÑÏõÉ');
                                }
                            }, 100);

                            // 1ÌöåÏö©Ïù¥Î©¥ ÏÇ≠Ï†ú (ÏÉàÎ°úÍ≥†Ïπ® Ïãú ÏÇ¨ÎùºÏßÄÎäî Í≤å Ïã´Îã§Î©¥ Ï£ºÏÑù Ï≤òÎ¶¨)
                            // localStorage.removeItem('temp_circuit_snapshot');
                        } catch (e) {
                            console.error('Snapshot load error:', e);
                        }
                    }
                }
            });
        </script>

        <!-- Settings Modal -->
        <div class="modal-overlay" id="settings-modal" style="display: none; z-index: 3000;">
            <div class="modal-window"
                style="width: 400px; background: var(--bg-surface); border: 1px solid var(--border-default); box-shadow: 0 20px 50px rgba(0,0,0,0.5); padding: 24px; border-radius: 12px;">
                <div class="modal-header"
                    style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="margin: 0; font-size: 18px; font-weight: 600; color: var(--text-primary);">ÏÑ§Ï†ï
                        (Settings)</h2>
                    <button onclick="sim.closeSettings()"
                        style="background:none; border:none; color:var(--text-secondary); cursor:pointer;">
                        <svg width="20" height="20">
                            <use href="#icon-close" />
                        </svg>
                    </button>
                </div>

                <div class="settings-group" style="margin-bottom: 24px;">
                    <label style="display:block; color:var(--text-secondary); font-size:12px; margin-bottom: 8px;">Ïñ∏Ïñ¥
                        (Language)</label>
                    <select id="sim-setting-language" onchange="sim.setLanguage(this.value)"
                        style="width: 100%; padding: 10px; background: var(--bg-active); border: 1px solid var(--border-default); color: var(--text-primary); border-radius: 6px;">
                        <option value="ko">ÌïúÍµ≠Ïñ¥</option>
                        <option value="en">English</option>
                        <option value="ja">Êó•Êú¨Ë™û</option>
                    </select>
                </div>

                <div class="settings-group" style="margin-bottom: 24px;">
                    <label style="display:block; color:var(--text-secondary); font-size:12px; margin-bottom: 8px;">UI
                        ÌÅ¨Í∏∞
                        (Scale)</label>
                    <div style="display:flex; align-items:center; gap: 12px;">
                        <span style="font-size:12px; color:var(--text-muted);">80%</span>
                        <input type="range" id="sim-setting-ui-scale" min="0.8" max="1.2" step="0.05" value="1.0"
                            oninput="sim.setUIScale(parseFloat(this.value))"
                            style="flex: 1; accent-color: var(--accent-blue);">
                        <span style="font-size:12px; color:var(--text-muted);">120%</span>
                    </div>
                    <div style="text-align:center; font-size: 12px; color: var(--accent-blue); margin-top: 4px;"
                        id="ui-scale-value">100%</div>
                </div>



                <div style="text-align: right;">
                    <button onclick="sim.closeSettings()"
                        style="padding: 8px 16px; background: var(--accent-blue); color: white; border: none; border-radius: 6px; font-weight: 500; cursor: pointer;">
                        ÌôïÏù∏
                    </button>
                </div>
            </div>
        </div>
        <script>
            // Apply UI Scale on load
            (function () {
                const s = localStorage.getItem('locad_ui_scale');
                if (s) {
                    document.body.style.zoom = s;
                }
            })();

            // Initialize Standard Packages
            window.addEventListener('load', function () {
                setTimeout(() => {
                    if (typeof sim !== 'undefined' && sim.renderStandardPackages) {
                        console.log('Rendering standard packages...');
                        sim.renderStandardPackages();
                    }
                }, 500);
            });
        </script>

        <!-- Í≥†Í∏â Í∏∞Îä• Î™®Îìà -->
        <script src="js/modules/AdvancedComponents.js"></script>
        <script src="js/modules/Minimap.js"></script>
        <script src="js/modules/TimingAnalyzer.js"></script>
        <script src="js/modules/PuzzleSystem.js"></script>

</body>

</html>