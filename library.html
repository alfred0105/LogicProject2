<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì»¤ë®¤ë‹ˆí‹° ë¼ì´ë¸ŒëŸ¬ë¦¬ - LoCAD</title>
    <link rel="icon" href="favicon.svg" type="image/svg+xml">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/library.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/modules/Security.js"></script>
    <script src="js/modules/SupabaseClient.js"></script>
    <script src="js/modules/LibraryManager.js"></script>
</head>

<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand" onclick="location.href='index.html'">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2">
                    <path
                        d="M6 6 L10 2 L12 6 H20 A2 2 0 0 1 22 8 V17 A2 2 0 0 1 20 19 H14 L10 23 L9 19 H4 A2 2 0 0 1 2 17 V8 A2 2 0 0 1 4 6 Z">
                    </path>
                    <circle cx="9" cy="12.5" r="1.5" fill="currentColor" stroke="none"></circle>
                    <circle cx="15" cy="12.5" r="1.5" fill="currentColor" stroke="none"></circle>
                </svg>
                <span>LoCAD</span>
            </div>

            <div class="nav-links">
                <a href="index.html">í™ˆ</a>
                <a href="library.html" class="active">ë¼ì´ë¸ŒëŸ¬ë¦¬</a>
                <a href="simulator.html">ì‹œë®¬ë ˆì´í„°</a>
            </div>

            <div class="nav-user">
                <div id="user-info" class="user-info">
                    <a href="login.html" class="btn-login">ë¡œê·¸ì¸</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <section class="hero-section">
        <div class="hero-content">
            <h1>ì»¤ë®¤ë‹ˆí‹° íšŒë¡œ ë¼ì´ë¸ŒëŸ¬ë¦¬</h1>
            <p>ì „ ì„¸ê³„ ì‚¬ìš©ìë“¤ì´ ê³µìœ í•œ ë…¼ë¦¬ íšŒë¡œë¥¼ íƒìƒ‰í•˜ê³  í•™ìŠµí•˜ì„¸ìš”</p>

            <!-- Search Bar -->
            <div class="search-container">
                <input type="text" id="search-input" placeholder="íšŒë¡œ ê²€ìƒ‰... (ì˜ˆ: half adder, counter)"
                    onkeypress="if(event.key==='Enter') searchProjects()">
                <button onclick="searchProjects()" class="btn-search">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                    ê²€ìƒ‰
                </button>
            </div>
        </div>
    </section>

    <!-- Main Content -->
    <main class="library-container">
        <!-- Filters -->
        <div class="filters-section">
            <div class="filter-group">
                <button class="filter-btn active" data-filter="trending" onclick="applyFilter('trending')">
                    ğŸ”¥ ì¸ê¸°ìˆœ
                </button>
                <button class="filter-btn" data-filter="latest" onclick="applyFilter('latest')">
                    â° ìµœì‹ ìˆœ
                </button>
                <button class="filter-btn" data-filter="most_liked" onclick="applyFilter('most_liked')">
                    â¤ï¸ ì¢‹ì•„ìš”ìˆœ
                </button>
                <button class="filter-btn" data-filter="most_viewed" onclick="applyFilter('most_viewed')">
                    ğŸ‘ï¸ ì¡°íšŒìˆœ
                </button>
            </div>

            <!-- Tag Cloud -->
            <div class="tags-container">
                <span class="tag" onclick="filterByTag('logic')">logic</span>
                <span class="tag" onclick="filterByTag('adder')">adder</span>
                <span class="tag" onclick="filterByTag('counter')">counter</span>
                <span class="tag" onclick="filterByTag('flipflop')">flipflop</span>
                <span class="tag" onclick="filterByTag('multiplexer')">multiplexer</span>
                <span class="tag" onclick="filterByTag('decoder')">decoder</span>
                <span class="tag" onclick="filterByTag('beginner')">beginner</span>
                <span class="tag" onclick="filterByTag('advanced')">advanced</span>
            </div>
        </div>

        <!-- Projects Grid -->
        <div id="projects-grid" class="projects-grid">
            <div class="loading-spinner">
                <div class="spinner"></div>
                <p>íšŒë¡œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            </div>
        </div>

        <!-- Pagination -->
        <div id="pagination" class="pagination" style="display: none;">
            <button class="btn-page" onclick="prevPage()">ì´ì „</button>
            <span id="page-info">1 / 1</span>
            <button class="btn-page" onclick="nextPage()">ë‹¤ìŒ</button>
        </div>
    </main>

    <!-- Project Detail Modal -->
    <div id="project-modal" class="modal-overlay">
        <div class="modal-content project-modal">
            <button class="modal-close" onclick="closeProjectModal()">Ã—</button>

            <div class="modal-header">
                <h2 id="modal-title">í”„ë¡œì íŠ¸ ì œëª©</h2>
                <div class="project-stats">
                    <span>ğŸ‘ï¸ <span id="modal-views">0</span></span>
                    <span>â¤ï¸ <span id="modal-likes">0</span></span>
                    <span>ğŸ´ <span id="modal-forks">0</span></span>
                </div>
            </div>

            <div class="modal-body">
                <p id="modal-description">í”„ë¡œì íŠ¸ ì„¤ëª…</p>

                <div id="modal-tags" class="modal-tags"></div>

                <div class="modal-actions">
                    <button class="btn-action" id="btn-like" onclick="toggleLike()">
                        â¤ï¸ ì¢‹ì•„ìš”
                    </button>
                    <button class="btn-action" onclick="forkProject()">
                        ğŸ´ í¬í¬
                    </button>
                    <button class="btn-action btn-primary" onclick="openProject()">
                        â–¶ï¸ ì—´ê¸°
                    </button>
                </div>

                <!-- Comments Section -->
                <div class="comments-section">
                    <h3>ëŒ“ê¸€ (<span id="comment-count">0</span>)</h3>

                    <div class="comment-input-container">
                        <textarea id="comment-input" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..." rows="3"></textarea>
                        <button onclick="addComment()" class="btn-comment">ëŒ“ê¸€ ì‘ì„±</button>
                    </div>

                    <div id="comments-list" class="comments-list">
                        <!-- ëŒ“ê¸€ë“¤ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let library;
        let currentPage = 1;
        let currentFilter = 'trending';
        let currentProjectId = null;
        let currentProject = null;

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', async () => {
            // ë¼ì´ë¸ŒëŸ¬ë¦¬ ê´€ë¦¬ì ì´ˆê¸°í™”
            if (window.LibraryManager) {
                library = new LibraryManager();
                await loadProjects();
            }

            // ì‚¬ìš©ì ì •ë³´ ì—…ë°ì´íŠ¸
            updateUserInfo();
        });

        // ì‚¬ìš©ì ì •ë³´ ì—…ë°ì´íŠ¸
        async function updateUserInfo() {
            if (!window.sb) return;

            const { data: { user } } = await window.sb.auth.getUser();
            const userInfo = document.getElementById('user-info');

            if (user) {
                const name = user.user_metadata?.full_name || user.email.split('@')[0];
                userInfo.innerHTML = `
                    <div class="user-avatar">${name.charAt(0).toUpperCase()}</div>
                    <span>${name}</span>
                    <a href="dashboard.html" class="btn-dashboard">ëŒ€ì‹œë³´ë“œ</a>
                `;
            }
        }

        // í”„ë¡œì íŠ¸ ë¡œë“œ
        async function loadProjects() {
            const grid = document.getElementById('projects-grid');
            grid.innerHTML = '<div class="loading-spinner"><div class="spinner"></div><p>íšŒë¡œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p></div>';

            try {
                const projects = await library.getPublicProjects(currentFilter, currentPage);

                if (projects.length === 0) {
                    grid.innerHTML = '<div class="empty-state"><p>ğŸ” í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤</p></div>';
                    return;
                }

                grid.innerHTML = projects.map(project => createProjectCard(project)).join('');

                // í˜ì´ì§€ë„¤ì´ì…˜ ì—…ë°ì´íŠ¸
                updatePagination();
            } catch (error) {
                console.error('Failed to load projects:', error);
                grid.innerHTML = '<div class="error-state"><p>âŒ í”„ë¡œì íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤</p></div>';
            }
        }

        // í”„ë¡œì íŠ¸ ì¹´ë“œ ìƒì„±
        function createProjectCard(project) {
            const title = project.title || 'Untitled Project';
            const description = project.description || 'ì„¤ëª… ì—†ìŒ';
            const tags = project.tags || [];
            const views = project.views || 0;
            const likes = project.likes || 0;
            const forks = project.forks || 0;

            return `
                <div class="project-card" onclick="showProjectDetail('${project.id}')">
                    <div class="card-thumbnail">
                        ${project.thumbnail_url ?
                    `<img src="${project.thumbnail_url}" alt="${title}">` :
                    `<div class="thumbnail-placeholder">
                                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                    <rect x="3" y="3" width="18" height="18" rx="2"></rect>
                                    <line x1="9" y1="9" x2="15" y2="9"></line>
                                    <line x1="9" y1="15" x2="15" y2="15"></line>
                                </svg>
                            </div>`
                }
                    </div>
                    <div class="card-content">
                        <h3 class="card-title">${title}</h3>
                        <p class="card-description">${description.substring(0, 100)}${description.length > 100 ? '...' : ''}</p>
                        <div class="card-tags">
                            ${tags.slice(0, 3).map(tag => `<span class="tag-small">${tag}</span>`).join('')}
                        </div>
                        <div class="card-stats">
                            <span>ğŸ‘ï¸ ${views}</span>
                            <span>â¤ï¸ ${likes}</span>
                            <span>ğŸ´ ${forks}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        // í”„ë¡œì íŠ¸ ìƒì„¸ ë³´ê¸°
        async function showProjectDetail(projectId) {
            const modal = document.getElementById('project-modal');
            currentProjectId = projectId;

            try {
                // í”„ë¡œì íŠ¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                const { data, error } = await window.sb
                    .from('projects')
                    .select('*')
                    .eq('id', projectId)
                    .single();

                if (error) throw error;

                currentProject = data;

                // ëª¨ë‹¬ ë‚´ìš© ì±„ìš°ê¸°
                document.getElementById('modal-title').textContent = data.title || 'Untitled Project';
                document.getElementById('modal-description').textContent = data.description || 'ì„¤ëª… ì—†ìŒ';
                document.getElementById('modal-views').textContent = data.views || 0;
                document.getElementById('modal-likes').textContent = data.likes || 0;
                document.getElementById('modal-forks').textContent = data.forks || 0;

                // íƒœê·¸
                const tagsContainer = document.getElementById('modal-tags');
                if (data.tags && data.tags.length > 0) {
                    tagsContainer.innerHTML = data.tags.map(tag => `<span class="tag">${tag}</span>`).join('');
                } else {
                    tagsContainer.innerHTML = '';
                }

                // ì¢‹ì•„ìš” ìƒíƒœ í™•ì¸
                const isLiked = await library.isProjectLiked(projectId);
                const btnLike = document.getElementById('btn-like');
                if (isLiked) {
                    btnLike.textContent = 'ğŸ’” ì¢‹ì•„ìš” ì·¨ì†Œ';
                    btnLike.classList.add('liked');
                } else {
                    btnLike.textContent = 'â¤ï¸ ì¢‹ì•„ìš”';
                    btnLike.classList.remove('liked');
                }

                // ëŒ“ê¸€ ë¡œë“œ
                await loadComments();

                // ì¡°íšŒìˆ˜ ì¦ê°€
                await library.incrementViews(projectId);

                modal.classList.add('show');
            } catch (error) {
                console.error('Failed to load project:', error);
                alert('í”„ë¡œì íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ëª¨ë‹¬ ë‹«ê¸°
        function closeProjectModal() {
            document.getElementById('project-modal').classList.remove('show');
            currentProjectId = null;
            currentProject = null;
        }

        // ì¢‹ì•„ìš” í† ê¸€
        async function toggleLike() {
            if (!currentProjectId) return;

            try {
                const result = await library.likeProject(currentProjectId);
                const btnLike = document.getElementById('btn-like');

                if (result.liked) {
                    btnLike.textContent = 'ğŸ’” ì¢‹ì•„ìš” ì·¨ì†Œ';
                    btnLike.classList.add('liked');
                    const likesEl = document.getElementById('modal-likes');
                    likesEl.textContent = parseInt(likesEl.textContent) + 1;
                } else {
                    btnLike.textContent = 'â¤ï¸ ì¢‹ì•„ìš”';
                    btnLike.classList.remove('liked');
                    const likesEl = document.getElementById('modal-likes');
                    likesEl.textContent = parseInt(likesEl.textContent) - 1;
                }
            } catch (error) {
                alert(error.message);
            }
        }

        // í”„ë¡œì íŠ¸ í¬í¬
        async function forkProject() {
            if (!currentProjectId) return;

            if (!confirm('ì´ í”„ë¡œì íŠ¸ë¥¼ í¬í¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                const forked = await library.forkProject(currentProjectId);
                alert('âœ“ í”„ë¡œì íŠ¸ê°€ í¬í¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
                // ëŒ€ì‹œë³´ë“œë¡œ ì´ë™
                location.href = `simulator.html?id=${forked.id}`;
            } catch (error) {
                alert(error.message);
            }
        }

        // í”„ë¡œì íŠ¸ ì—´ê¸°
        function openProject() {
            if (!currentProjectId) return;
            location.href = `simulator.html?id=${currentProjectId}`;
        }

        // ëŒ“ê¸€ ë¡œë“œ
        async function loadComments() {
            if (!currentProjectId) return;

            try {
                const comments = await library.getComments(currentProjectId);
                const commentsList = document.getElementById('comments-list');
                document.getElementById('comment-count').textContent = comments.length;

                if (comments.length === 0) {
                    commentsList.innerHTML = '<p class="no-comments">ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                    return;
                }

                commentsList.innerHTML = comments.map(comment => `
                    <div class="comment-item">
                        <div class="comment-header">
                            <strong>${comment.user_name}</strong>
                            <span class="comment-date">${new Date(comment.created_at).toLocaleDateString()}</span>
                        </div>
                        <p class="comment-content">${comment.content}</p>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Failed to load comments:', error);
            }
        }

        // ëŒ“ê¸€ ì‘ì„±
        async function addComment() {
            const input = document.getElementById('comment-input');
            const content = input.value.trim();

            if (!content) {
                alert('ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }

            try {
                await library.addComment(currentProjectId, content);
                input.value = '';
                await loadComments();
            } catch (error) {
                alert(error.message);
            }
        }

        // ê²€ìƒ‰
        async function searchProjects() {
            const query = document.getElementById('search-input').value.trim();
            if (!query) return;

            const grid = document.getElementById('projects-grid');
            grid.innerHTML = '<div class="loading-spinner"><div class="spinner"></div><p>ê²€ìƒ‰ ì¤‘...</p></div>';

            try {
                const results = await library.searchProjects(query);

                if (results.length === 0) {
                    grid.innerHTML = '<div class="empty-state"><p>ğŸ” ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</p></div>';
                    return;
                }

                grid.innerHTML = results.map(project => createProjectCard(project)).join('');
            } catch (error) {
                console.error('Search failed:', error);
                grid.innerHTML = '<div class="error-state"><p>âŒ ê²€ìƒ‰ ì‹¤íŒ¨</p></div>';
            }
        }

        // í•„í„° ì ìš©
        function applyFilter(filter) {
            currentFilter = filter;
            currentPage = 1;

            // ë²„íŠ¼ í™œì„±í™” ìƒíƒœ ë³€ê²½
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-filter="${filter}"]`).classList.add('active');

            loadProjects();
        }

        // íƒœê·¸ë¡œ í•„í„°ë§
        async function filterByTag(tag) {
            const grid = document.getElementById('projects-grid');
            grid.innerHTML = '<div class="loading-spinner"><div class="spinner"></div><p>ê²€ìƒ‰ ì¤‘...</p></div>';

            try {
                const results = await library.getProjectsByTag(tag);

                if (results.length === 0) {
                    grid.innerHTML = '<div class="empty-state"><p>ğŸ” ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</p></div>';
                    return;
                }

                grid.innerHTML = results.map(project => createProjectCard(project)).join('');
            } catch (error) {
                console.error('Filter failed:', error);
                grid.innerHTML = '<div class="error-state"><p>âŒ í•„í„°ë§ ì‹¤íŒ¨</p></div>';
            }
        }

        // í˜ì´ì§€ë„¤ì´ì…˜
        function updatePagination() {
            const pagination = document.getElementById('pagination');
            const pageInfo = document.getElementById('page-info');

            // ê°„ë‹¨í•œ êµ¬í˜„ (ì‹¤ì œë¡œëŠ” ì´ í˜ì´ì§€ ìˆ˜ë¥¼ ì„œë²„ì—ì„œ ë°›ì•„ì™€ì•¼ í•¨)
            pageInfo.textContent = `${currentPage} / ?`;
            pagination.style.display = 'flex';
        }

        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                loadProjects();
            }
        }

        function nextPage() {
            currentPage++;
            loadProjects();
        }
    </script>
</body>

</html>